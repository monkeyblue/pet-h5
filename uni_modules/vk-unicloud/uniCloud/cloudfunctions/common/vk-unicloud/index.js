"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var crypto$1=_interopDefault(require("crypto")),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},util={regExpTest:function(e,t){let n=!1;if("string"==typeof e){new RegExp(e).test(t)&&(n=!0)}else if("object"==typeof e)for(let a=0;a<e.length;a++){if(new RegExp(e[a]).test(t)){n=!0;break}}else"function"==typeof e&&(n=e(t));return n}},util_1=util,onActionExecuting=async(e={})=>{let{serviceParam:t,middlewareService:n=[]}=e,a={code:403,msg:"access denied",filterStack:[]},{url:i}=t;for(let e in n){let r=n[e],{mode:o="onActionExecuting",enable:s=!0}=r;if(s&&"onActionExecuting"===o&&util_1.regExpTest(r.regExp,i)){let e;t.filterResponse=a;try{e=await r.main(t)}catch(e){throw r.modulesName&&(e.msg=`云函数 ${i} 的中间件 ${r.modulesName}（id:${r.id}）运行异常：${e.message}`),e}if(e.filterId=r.id,a.filterStack.push(e),0!==e.code){a=e;break}a=Object.assign(a,e)}}return a},onActionExecuted=async(e={})=>{let{serviceParam:t,middlewareService:n=[],serviceRes:a}=e,{url:i}=t;for(let e in n){let r=n[e],{mode:o,enable:s=!0}=r;if(s&&"onActionExecuted"===o&&util_1.regExpTest(r.regExp,i)){let e;try{e=await r.main(t,a)}catch(e){throw r.modulesName&&(e.msg=`云函数 ${i} 的中间件 ${r.modulesName}（id:${r.id}）运行异常：${e.message}`),e}if(e){if(0!==e.code){a=e;break}a=Object.assign(a,e)}}}return a},onActionIntercepted=async(e={})=>{let{serviceParam:t,middlewareService:n=[],filterResponse:a}=e,{url:i}=t;for(let e in n){let r=n[e],{mode:o,enable:s=!0}=r;if(s&&"onActionIntercepted"===o&&util_1.regExpTest(r.regExp,i)){let e=await r.main(t,a);if(e){if(0!==e.code){a=e;break}a=Object.assign(a,e)}}}return a},onActionError=async(e={})=>{let{serviceParam:t,middlewareService:n=[],serviceRes:a}=e,{url:i}=t;for(let e in n){let r=n[e],{mode:o,enable:s=!0}=r;if(s&&"onActionError"===o&&util_1.regExpTest(r.regExp,i)){let e=await r.main(t,a);if(e){if(0!==e.code){a=e;break}a=Object.assign(a,e)}}}return a},checkIsLogin={main:async e=>{let{url:t,data:n={},util:a}=e,{uniID:i,config:r={},vk:o,db:s,_:u}=a,{need_user_info:l}=n,c={code:-1,msg:""};void 0===l&&(l=-1==t.indexOf("."));let d=0==t.indexOf("admin/");d&&(l=!0),(t.indexOf("sys.")>-1||t.indexOf("sys_")>-1||t.indexOf("/sys")>-1)&&(l=!0);let p=t.indexOf("/sys/")>-1,f=await i.checkToken(e.uniIdToken,{needPermission:p,needUserInfo:l});if(f.code&&f.code>0)return f;if(f.userInfo){let e=f.userInfo;e.permission=f.permission,delete e.token,delete e.password,c.userInfo=e}if(c.uid=f.uid,f.token){c.token=f.token,c.tokenExpired=f.tokenExpired;try{if(c.userInfo){let e=o.pubfn.getUniIdConfig(r,"tokenMaxLimit",10);if(e>0){let t="uni-id-users",n=(await o.baseDao.findById({dbName:t,id:c.userInfo._id,fieldJson:{token:!0}})).token||[];n.length>e&&(n=n.splice(-1*e),await o.baseDao.updateById({dbName:t,id:c.userInfo._id,dataJson:{token:u.set(n)}}))}}}catch(e){}}if(d){if(!c.userInfo)return{code:403,msg:"need_user_info必须为true"};{let e=c.userInfo.role||[];if(!c.userInfo.allow_login_background&&!e.includes("admin"))return{code:403,msg:"您无权限登录后台"}}}return c.code=0,c.msg="ok",c}},checkSysAuth={main:async e=>{let{url:t,util:n}=e,{config:a,pubFun:i,vk:r,db:o,_:s}=n,u={code:-1,msg:""};const l=checkIsLogin;if(u=await l.main(e),0!==u.code)return u;if(!u.userInfo)return{code:403,msg:"请去除need_user_info:false"};if(u.userInfo.role||(u.userInfo.role=[]),u.userInfo.role.includes("admin"))return u;if(!u.userInfo.allow_login_background&&0==t.indexOf("admin/"))return{code:403,msg:"您无权限登录后台"};let c=[];if(u.userInfo.role.includes("admin-lv3")){let e=await listPermission({whereJson:{level:s.in([1,2,3])},justNeedID:!0},n);r.pubfn.isNotNull(e)&&(c=c.concat(e))}if(u.userInfo.role.includes("admin-lv2")){let e=await listPermission({whereJson:{level:s.in([1,2])},justNeedID:!0},n);r.pubfn.isNotNull(e)&&(c=c.concat(e))}if(u.userInfo.role.includes("admin-lv1")){let e=await listPermission({whereJson:{level:s.in([1])},justNeedID:!0},n);r.pubfn.isNotNull(e)&&(c=c.concat(e))}if(u.userInfo.role.includes("query-all")){let e=await listPermission({whereJson:{curd_category:4,level:s.neq(4)},justNeedID:!0},n);r.pubfn.isNotNull(e)&&(c=c.concat(e))}let d=await listRole({role:u.userInfo.role},n);for(let e in d){let{permission:t}=d[e];r.pubfn.isNotNull(t)&&(c=c.concat(t))}if(0==c.length)return{code:403,msg:"权限不足"};c=[...new Set(c)];let p=await listPermission({whereJson:{permission_id:s.in(c),match_mode:s.in([1,2])}},n),f=!1;for(let e=0;e<p.length;e++){let n=p[e];if(1===n.match_mode){if(r.pubfn.wildcardTest(t,n.url)){f=!0;break}}else if(2===n.match_mode&&r.pubfn.regExpTest(t,n.url)){f=!0;break}}if(!f){await matchPermission({myPermission:c,url:t},n)&&(f=!0)}return f?(u.code=0,u.msg="ok",u):{code:403,msg:"权限不足"}}};async function listPermission(e={},t){let{vk:n,db:a,_:i}=t,{whereJson:r={},fieldJson:o={},justNeedID:s=!1}=e;s&&(o={permission_id:!0}),r.enable=!0;let u=[],l=await n.baseDao.select({dbName:"uni-id-permissions",pageIndex:1,pageSize:500,fieldJson:o,whereJson:r});if(s)for(let e=0;e<l.rows.length;e++){let t=l.rows[e];u.push(t.permission_id)}else u=l.rows;return u}async function matchPermission(e,t){let{vk:n,db:a,_:i}=t,{myPermission:r,url:o}=e;return!n.pubfn.isNull(r)&&await n.baseDao.count({dbName:"uni-id-permissions",whereJson:{enable:!0,permission_id:i.in(r),url:o,match_mode:i.nin([1,2])}})>0}async function listRole(e,t){let{vk:n,db:a,_:i}=t,{role:r}=e;return n.pubfn.isNull(r)?[]:(await n.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:i.in(r),enable:!0},fieldJson:{permission:!0}})).rows}var filterService=[{id:"pub",regExp:function(e=""){return"pub"===getType(e)},description:"pub函数为所有人都可以访问的函数",index:100,mode:"onActionExecuting",main:async function(e){let{url:t,data:n={},util:a}=e,{uniID:i}=a,r={};if(e.data.need_user_info)r=await checkIsLogin.main(e);else if(e.uniIdToken){let t=await i.checkToken(e.uniIdToken,{needPermission:!1,needUserInfo:!1});0===t.code&&(r.uid=t.uid)}return r.code=0,r.msg="ok",r}},{id:"kh",regExp:function(e=""){return"kh"===getType(e)},description:"kh函数为必须登录后才能访问的函数(客户端用户)",index:200,mode:"onActionExecuting",main:checkIsLogin.main},{id:"sys",regExp:function(e=""){return"sys"===getType(e)},description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:300,mode:"onActionExecuting",main:checkSysAuth.main},{id:"access_denied",regExp:function(e=""){return"access denied"===getType(e)},description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:100,mode:"onActionExecuting",main:function(){return{code:403,msg:"禁止访问私有函数！"}}}];function getType(e=""){let t="";return e.indexOf("/sys/")>-1?t="sys":e.indexOf("/kh/")>-1?t="kh":e.indexOf("/pub/")>-1&&(t="pub"),e.indexOf("/sys.")>-1||e.indexOf("/sys_")>-1||0===e.indexOf("sys.")||0===e.indexOf("sys_")?t="sys":e.indexOf("/kh.")>-1||e.indexOf("/kh_")>-1||0===e.indexOf("kh.")||0===e.indexOf("kh_")?t="kh":(e.indexOf("/pub.")>-1||e.indexOf("/pub_")>-1||0===e.indexOf("pub.")||0===e.indexOf("pub_"))&&(t="pub"),e.indexOf(".sys_")>-1?t="sys":e.indexOf(".kh_")>-1?t="kh":e.indexOf(".pub_")>-1&&(t="pub"),""==t&&e.indexOf(".")>-1&&(t="kh"),e.indexOf("._")>-1&&(t="access denied"),t}function getMiddleware(e){let t=[];if(e){let n=[...filterService,...e];n.sort((function(e,t){return e.index-t.index})),t=n.filter((e,t,a)=>{var i=[];return n.forEach((e,t)=>{i.push(e.id)}),i.indexOf(e.id)===t})}else t=filterService;return t}var getMiddleware_1=getMiddleware,filter={onActionExecuting:onActionExecuting,onActionExecuted:onActionExecuted,onActionIntercepted:onActionIntercepted,onActionError:onActionError,getMiddleware:getMiddleware_1},routerUtil={filterService:filter,getQueryStringParameters:function(e){let{event:t,vk:n}=e,a={};if(t.httpMethod){let{path:e=""}=t;if("/"===e[0]&&(e=e.substring(1)),e){let i,{urlrewrite:r={}}=n.getUnicloud(),{rule:o}=r,s=n.pubfn.getData(r,"config.accessOnlyInRule"),u=!1;if(o)for(let t in o){let a=o[t],r=n.pubfn.regExpExecToTemplate(e,t,a);if(r){u=!0;let t=r.split("?");e=t[0],i=n.pubfn.urlStringToJson(t[1]);break}}if(!u&&s)return{mpserverlessComposedResponse:!0,statusCode:403,code:403,headers:{"content-type":"application/json"},body:JSON.stringify({code:403,msg:"access denied"})};if(a={data:{}},n.pubfn.isNotNull(i)&&(a.data=Object.assign(a.data,i)),t.queryStringParameters){let e=t.queryStringParameters;"string"==typeof e&&(e=JSON.parse(e)),a.data=Object.assign(a.data,e)}if(t.body){let e=t.body,i=t.headers&&t.headers["content-type"]?t.headers["content-type"]:"";if(i.indexOf("multipart/form-data;")>-1)e=n.formDataUtil.formParser(t),a.data=Object.assign(a.data,e);else{t.isBase64Encoded&&(e=Buffer.from(e,"base64").toString("utf-8"));try{"string"==typeof e&&(e=JSON.parse(e)),a.data=Object.assign(a.data,e)}catch(e){}try{"string"==typeof e&&i.indexOf("x-www-form-urlencoded")>-1&&(e=n.pubfn.urlStringToJson(e),"object"==typeof e&&(e=n.pubfn.string2Number(e),a.data=Object.assign(a.data,e)))}catch(e){}}}a.$url||(a.data.$url?a.$url=a.data.$url:a.$url=e),a.data.uni_id_token&&(a.uni_id_token=a.data.uni_id_token,delete a.data.uni_id_token)}else{if(t.queryStringParameters){let e=t.queryStringParameters;"string"==typeof e.data&&(e.data=JSON.parse(e.data)),a=Object.assign(a,e)}if(t.body){let e=t.body;t.isBase64Encoded&&(e=Buffer.from(e,"base64").toString("utf-8"));try{"string"==typeof e&&(e=JSON.parse(e)),a=Object.assign(a,e)}catch(e){}}}try{let e=t.headers["uni-id-token"]||t.headers.uni_id_token;!a.uni_id_token&&e&&(a.uni_id_token=e)}catch(e){}}else a=JSON.parse(JSON.stringify(t));return a.data||(a.data={}),a.uniIdToken||(a.uniIdToken=a.uni_id_token),a.url=a.$url||"",a},returnError:returnError,filterInterception:async function({serviceParam:e,middlewareService:t,filterResponse:n}){try{n=await filter.onActionIntercepted({serviceParam:e,middlewareService:t,filterResponse:n})}catch(n){return await returnError({code:500,msg:`云函数 ${e.url} 的中间件 onActionIntercepted 运行异常!`,err:n,serviceParam:e,middlewareService:t})}return n},requireService:async function(e={}){let t,{vk:n,serviceParam:a}=e,{url:i,data:r,uniIdToken:o,util:s,filterResponse:u={},originalParam:l={}}=a;if(i.indexOf(".")>-1){let e,a=i.lastIndexOf("."),c=n.require("service/"+i.substring(0,a));if(t=n.pubfn.objectAssign({},c),!t.isCloudObject)throw new Error("msg:禁止访问私有对象内的函数！");let d=i.substring(a+1);if(0==d.indexOf("_"))throw new Error("msg:禁止访问私有函数！");if("function"!=typeof t[d]){try{l.event&&l.event.httpMethod&&l.event.path&&(i=l.event.path.substring(1))}catch(e){}throw{code:404,name:"cloudObject",message:`not found【${i}】`}}Object.assign(t,{vk:n,methodName:d,isCloudObject:!0,getClientInfo:function(){let{context:e={}}=l,t={...e,os:e.OS,appId:e.APPID,locale:e.LOCALE,clientIP:e.CLIENTIP,userAgent:e.CLIENTUA,platform:e.PLATFORM,deviceId:e.DEVICEID,source:e.SOURCE,uniIdToken:o,uid:u.uid,userInfo:u.userInfo,filterResponse:u,originalParam:l};return n.pubfn.objectKeySort(t)},getUserInfo:async function(){if(u.userInfo&&u.userInfo._id)return u.userInfo;if(!e&&u.uid){let t=await s.uniID.checkToken(o,{needUserInfo:!0});if(0!==t.code)throw new Error("msg:token失效："+t.errMsg);t.userInfo&&t.userInfo._id&&(delete t.userInfo.token,delete t.userInfo.password,e=t.userInfo)}return e},getUtil:function(){return s},getMethodName:function(){return d},getParams:function(){return r},getCloudInfo:function(){let{SPACEINFO:e={},FUNCTION_NAME:t,FUNCTION_TYPE:n}=l.context||{},{provider:a,spaceId:i}=e;return{provider:a,spaceId:i,functionName:t,functionType:"cloudobject"}},getUniIdToken:function(){return o},getUniCloudRequestId:function(){return l.context.requestId},getHttpInfo:function(){return l.event}})}else t=n.require("service/"+i);return t},serviceRun:async function(e={}){let t,{serviceParam:n={},serviceMain:a}=e,{filterResponse:i}=n;if(i.uid&&(n.uid=i.uid),i.userInfo&&(n.userInfo=i.userInfo),a.isCloudObject){let{methodName:e="main"}=a;if("function"==typeof a._before){let e=await a._before();if("string"==typeof e)return{code:-1,msg:e};if("object"==typeof e&&0!==e.code)return{code:e.code,msg:e.msg};if("boolean"==typeof e&&!1===e)return{code:-1,msg:""}}if(t=await a[e](n.data),"function"==typeof a._after){let e=await a._after({res:t||{}});"object"==typeof e&&(t=e)}}else t=await a.main(n);return"object"==typeof t&&(void 0===t.vk_uni_token&&"object"==typeof i&&i.token&&void 0!==i.tokenExpired&&(t.vk_uni_token={token:i.token,tokenExpired:i.tokenExpired}),t=routerUtil.returnRes(t)),t},errorCatch:async function(e={}){let{err:t,type:n,serviceParam:a,middlewareService:i,serviceMain:r={}}=e,{url:o,originalParam:s={}}=a;t||(t={});let{code:u}=t,l=t.message||t.msg||t.errMsg||"";if("run"===n&&"function"==typeof r._after){let e=await r._after({err:t});if(e)return e}let c={code:500,msg:l,err:t,serviceParam:a,middlewareService:i};try{s.event&&s.event.httpMethod&&s.event.path&&(o=s.event.path.substring(1))}catch(t){}return"MODULE_NOT_FOUND"==u&&l.indexOf("service/")>-1||"ENOENT"==u&&l.indexOf("service")>-1||404==u&&["cloudFunction","cloudObject"].indexOf(t.name)>-1?(t.stack=`Error: not found【${o}】`,Object.assign(c,{code:404,msg:`not found【${o}】`})):"MODULE_NOT_FOUND"==u&&l.indexOf("Cannot find module")>-1?Object.assign(c,{code:500,msg:l}):"InternalServerError"==u&&l.indexOf("_id_ dup key")>-1?Object.assign(c,{code:500,msg:"vk.baseDao.add : _id不能重复添加"}):0===l.indexOf("Cannot read property 'mp-weixin' of undefined")?Object.assign(c,{code:501,msg:"请先绑定微信"}):l.indexOf("Response timeout for 10000ms")>-1?Object.assign(c,{code:502,msg:"timeout 请求超时，请重试！"}):l.indexOf("msg:token失效")>-1?Object.assign(c,{code:30202,errMsg:l,msg:l}):l.indexOf("msg:禁止访问私有对象内的函数")>-1||l.indexOf("msg:禁止访问私有函数")>-1?Object.assign(c,{code:403,msg:l.substring(4)}):0===l.indexOf("msg:")?Object.assign(c,{code:501,msg:l.substring(4)}):"ReferenceError"===t.name?Object.assign(c,{code:501,msg:`云函数 ${o} 变量引用错误：${l}`}):"TypeError"===t.name?Object.assign(c,{code:501,msg:`云函数 ${o} 运行异常，类型错误：${l}`}):"InternalServerError"==u?Object.assign(c,{code:"InternalServerError",msg:"内部错误"}):"Error"===t.name?Object.assign(c,{code:t.code,msg:l}):t.stack?Object.assign(c,{code:500,msg:"require"==n?`云函数 ${o} 编译异常!`:`云函数 ${o} 运行异常!`}):"string"==typeof t?Object.assign(c,{code:-1,msg:t}):Object.assign(c,t),await returnError(c)},returnRes:function(e={}){return"object"==typeof e&&(void 0!==e.code||void 0!==e.errCode&&(e.code=e.errCode,e.msg=e.errMsg)),e}},routerUtil_1=routerUtil;async function returnError(e={}){let{code:t,msg:n,err:a,serviceParam:i,middlewareService:r}=e;console.error(n);let o={code:t,msg:n};a&&(a.stack?(console.error(a.stack),o.err={message:a.message,stack:a.stack,code:a.code}):o.err=a);try{o.requestId=i.originalParam.context.requestId}catch(a){}let s=await filter.onActionError({serviceParam:i,middlewareService:r,serviceRes:o});return routerUtil.returnRes(s)}try{process.env.TZ="Asia/Shanghai"}catch(e){}async function main(e){let{event:t,context:n,vk:a}=e;!a&&this&&(a=this);let{config:i,uniID:r,uniPay:o,db:s,middlewareService:u,pubFun:l,customUtil:c,crypto:d}=a.getUnicloud();if(a.pubfn.getData(i,"vk.system.serviceShutdown"))return routerUtil_1.returnRes({code:405,msg:a.pubfn.getData(i,"vk.system.serviceShutdownDescription")});if(["h5","web"].indexOf(n.PLATFORM)>-1){let e=a.pubfn.getUniIdConfig(i,"preferedWebPlatform","h5");n.PLATFORM=e}else if(["app-plus","app"].indexOf(n.PLATFORM)>-1){let e=a.pubfn.getUniIdConfig(i,"preferedAppPlatform","app-plus");n.PLATFORM=e}let p={event:t,context:n},f=routerUtil_1.getQueryStringParameters(e),{url:g,data:m={},uniIdToken:b}=f;if([403].indexOf(f.code)>-1)return routerUtil_1.returnRes(f);if(g&&"function"==typeof g.trim&&(g=g.trim()),m){m.vk_appId&&(n.APPID=m.vk_appId),m.vk_appid&&(n.APPID=m.vk_appid),m.vk_platform&&(n.PLATFORM=m.vk_platform),m.vk_locale&&(n.LOCALE=m.vk_locale);let e={};if("object"==typeof t.headers&&(t.headers["vk-appId"]&&(e.appId=t.headers["vk-appId"]),t.headers["vk-appid"]&&(e.appid=t.headers["vk-appid"]),t.headers["vk-platform"]&&(e.platform=t.headers["vk-platform"]),t.headers["vk-locale"]&&(e.locale=t.headers["vk-locale"]),t.headers["vk-device-id"]&&(e.deviceId=t.headers["vk-device-id"]),t.headers["vk-client-ip"]&&(e.clientIP=t.headers["vk-client-ip"]),t.headers["vk-os"]&&(e.os=t.headers["vk-os"])),"object"==typeof m.vk_context&&(e=a.pubfn.objectAssign(e,m.vk_context),delete m.vk_context),"object"==typeof e&&a.pubfn.isNotNull(e)&&(e.appId&&(n.APPID=e.appId),e.appid&&(n.APPID=e.appid),e.platform&&(n.PLATFORM=e.platform),e.locale&&(n.LOCALE=e.locale),e.clientIP&&!n.CLIENTIP&&(n.CLIENTIP=e.clientIP),e.os&&(n.OS=e.os),e.deviceId&&(n.DEVICEID=e.deviceId),"function"===n.SOURCE&&(e.clientIP&&(n.CLIENTIP=e.clientIP),e.userAgent&&(n.CLIENTUA=e.userAgent))),a.pubfn.isNullOne(n.APPID,n.PLATFORM)){let e=a.pubfn.getData(i,"vk.context");a.pubfn.isNotNull(e)&&(n.APPID||(n.APPID=e.APPID),n.PLATFORM||(n.PLATFORM=e.PLATFORM),n.LOCALE||(n.LOCALE=e.LOCALE),n.CLIENTIP||(n.CLIENTIP=e.CLIENTIP))}}const h=r.createInstance({context:n});s.command.$=s.command.aggregate;let y={vk:a,config:i,pubFun:l,uniID:h,uniPay:o,db:s,_:s.command,$:s.command.aggregate,customUtil:c,crypto:d,env:{APPID:n.APPID,CLIENTIP:n.CLIENTIP,DEVICEID:n.DEVICEID,LOCALE:n.LOCALE,OS:n.OS,PLATFORM:n.PLATFORM,CLIENTUA:n.CLIENTUA}};try{uniCloud.vk=a,uniCloud.env=y.env,uniCloud.context=n}catch(e){}let w={url:g,data:m,uniIdToken:b,util:y,originalParam:p};const _=routerUtil_1.filterService.getMiddleware(u);try{let e=await routerUtil_1.filterService.onActionExecuting({serviceParam:w,middlewareService:_});if(0!==e.code)return routerUtil_1.returnRes(await routerUtil_1.filterInterception({serviceParam:w,middlewareService:_,filterResponse:e}));delete m.uid,e.uid&&(m.uid=e.uid),w.filterResponse=e}catch(e){return await routerUtil_1.returnError({code:500,msg:e.msg||`云函数 ${g} 的中间件 onActionExecuting 运行异常!`,err:e,serviceParam:w,middlewareService:_})}let k,v;try{k=await routerUtil_1.requireService({vk:a,serviceParam:w})}catch(e){return await routerUtil_1.errorCatch({err:e,type:"require",serviceParam:w,middlewareService:_})}try{v=await routerUtil_1.serviceRun({serviceParam:w,serviceMain:k})}catch(e){return await routerUtil_1.errorCatch({err:e,type:"run",serviceParam:w,middlewareService:_,serviceMain:k})}try{v=await routerUtil_1.filterService.onActionExecuted({serviceParam:w,middlewareService:_,serviceRes:v})}catch(e){return await routerUtil_1.returnError({code:500,msg:e.msg||`云函数 ${g} 的中间件 onActionExecuted 运行异常!`,err:e,serviceParam:w,middlewareService:_})}return routerUtil_1.returnRes(v)}var router=main,md5=function(e){return crypto$1.createHash("md5").update(e).digest("hex")},util$1={},baseDao={init:function(e){util$1=e}};const DB_MAX_LIMIT=1e3,DB_PAGE_SIZE=10;baseDao.add=async function(e){let{db:t,_:n,vk:a,config:i}=util$1,{dbName:r,dataJson:o,db:s,cancelAddTime:u,cancelAddTimeStr:l}=e;if(a.pubfn.isNull(r))throw new Error("vk.baseDao.add 中 dbName 不能为空");if(a.pubfn.isNull(o))throw new Error("vk.baseDao.add 中 dataJson 不能为空");let c={...o},d=s||t;if(!c._add_time){let e=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTime");void 0===u&&e&&(u=e);let t=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTimeStr");if(void 0===l&&t&&(l=t),!u){let e=new Date;c._add_time=e.getTime(),l||(c._add_time_str=a.pubfn.timeFormat(e,"yyyy-MM-dd hh:mm:ss"))}}let p=await d.collection(r).add(c);return p.id?p.id:null},baseDao.adds=async function(e){let{db:t,_:n,vk:a,config:i}=util$1,{dbName:r,dataJson:o,db:s,cancelAddTime:u,cancelAddTimeStr:l}=e;if(a.pubfn.isNull(r))throw new Error("vk.baseDao.adds 中 dbName 不能为空");if(a.pubfn.isNull(o))throw new Error("vk.baseDao.adds 中 dataJson 不能为空");if("[object Array]"!==Object.prototype.toString.call(o))throw new Error("vk.baseDao.adds 中 dataJson 必须是数组对象");let c=s||t,d=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTime");void 0===u&&d&&(u=d);let p=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTimeStr");void 0===l&&p&&(l=p);let f=o.map(e=>({...e}));if(!u){let e=new Date,t=e.getTime(),n=a.pubfn.timeFormat(e,"yyyy-MM-dd hh:mm:ss");for(let e in f)f[e]._add_time||(f[e]._add_time=t,l||(f[e]._add_time_str=n))}let g=await c.collection(r).add(f);return g.ids?g.ids:g.id?g.id:null},baseDao.del=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,whereJson:r,db:o}=e,s=o||n,u=0;if(t.pubfn.isNotNull(r)){let e=await s.collection(i).where(r).remove();e?u=e.deleted:(console.error(e.errMsg),u=-1)}else console.error("whereJson条件不能为空");return u},baseDao.delete=async function(e){return await baseDao.del(e)},baseDao.remove=async function(e){return await baseDao.del(e)},baseDao.deleteById=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,id:r,db:o}=e,s=o||n,u=0;if(t.pubfn.isNull(r))throw new Error("deleteById的id不能为空,且必须是字符串");let l=await s.collection(i).doc(r).remove();return l?u=l.deleted:(console.error(l.errMsg),u=0),u},baseDao.update=async function(e){let t,{vk:n,db:a,_:i}=util$1,{dbName:r,whereJson:o,dataJson:s,db:u}=e,l=u||a,c=0;if(n.pubfn.isNull(o))throw new Error("update的whereJson不能为空，且必须是对象形式");if(n.pubfn.isNull(s))throw new Error("update的dataJson不能为空，且必须是对象形式");return s._id&&delete s._id,t=void 0===o?await l.collection(r).update(s):await l.collection(r).where(o).update(s),t?c=t.updated:console.error(t.errMsg),c},baseDao.updateById=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,id:r,dataJson:o,getUpdateData:s,db:u}=e,l=u||n,c=0;if(t.pubfn.isNull(r))throw new Error("updateById的id不能为空，且必须是字符串");if(t.pubfn.isNull(o))throw new Error("updateById的dataJson不能为空，且必须是对象形式");o._id===r&&delete o._id;let d=await l.collection(i).doc(r).update(o);return s?d?await baseDao.findById({db:l,dbName:i,id:r}):null:(d?c=d.updated:(console.error(d.errMsg),c=0),c)},baseDao.updateAndReturn=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,id:r,whereJson:o,dataJson:s,db:u}=e,l=u||n;if(t.pubfn.isNullAll(r,o))throw new Error("updateAndReturn的id和whereJson两者不能都为空");if(t.pubfn.isNull(s))throw new Error("updateAndReturn的dataJson不能为空，且必须是对象形式");if(s._id&&delete s._id,t.pubfn.isNotNull(r)){return(await l.collection(i).doc(r).updateAndReturn(s)).doc}if(t.pubfn.isNotNull(o)){return(await l.collection(i).where(o).updateAndReturn(s)).doc}throw new Error("updateAndReturn的id和whereJson两者不能都为空")},baseDao.setById=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,id:r,dataJson:o,db:s}=e,u=s||n;if(t.pubfn.isNull(o))throw new Error("setById的dataJson不能为空，且必须是对象形式");if(t.pubfn.isNullAll(r,o._id))throw new Error("id或dataJson._id不能均为空");if(t.pubfn.isNotNullAll(r,o._id)&&r!==o._id)throw new Error("id和dataJson._id必须一致");t.pubfn.isNotNull(o._id)&&(r=o._id,delete o._id);let l=await u.collection(i).doc(r).set(o);return l.updated>0?l.type="update":(l.type="add",l.id=l.upsertedId||r),l},baseDao.select=async function(e={}){let{vk:t,db:n,_:a}=util$1;"string"==typeof e.pageIndex&&(e.pageIndex=parseInt(e.pageIndex)),"string"==typeof e.pageSize&&(e.pageSize=parseInt(e.pageSize));let{dbName:i,whereJson:r,pageSize:o=DB_PAGE_SIZE,getOne:s=!1,getMain:u=!1,debug:l=!1,hasMore:c=!1}=e;if(s&&(o=1),o<=0&&(o=999999999),o>DB_MAX_LIMIT)return await baseDao.selectAll(e);let d,p={rows:0,count:0},f=await baseDao.getSelectData(e),{result:g,hasMore:m,total:b,getCount:h,pageIndex:y,fieldJson:w,runTime:_=0}=f;h&&(c=!1);let k,v=c?o+1:o;return g=g.skip((y-1)*o).limit(v),t.pubfn.isNotNull(w)&&(g=g.field(w)),l&&(d=Date.now()),g=await g.get(),l&&(p.count=_,p.rows=Date.now()-d,p.total=p.rows+p.count),l&&(k={runTime:p}),baseDao.returnSelectsRes({rows:g.data,getCount:h,total:b,hasMore:m,pageIndex:y,pageSize:o,getOne:s,getMain:u,needAccurateHasMore:c,debug:k})},baseDao.findById=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,id:r,fieldJson:o,db:s}=e,u=(s||n).collection(i).doc(r);o&&(u=u.field(o));let l=await u.get();return"[object Array]"===Object.prototype.toString.call(l.data)?l.data[0]:l.data},baseDao.findByWhereJson=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,whereJson:r,fieldJson:o,sortArr:s,db:u}=e,l=u||n;if(t.pubfn.isNotNull(r)){let e=l.collection(i).where(r);if(s)for(let t in s){let n=s[t],a=n.name,i=n.type;null!=i&&""!=i||(i="asc"),e=e.orderBy(a,i)}o&&(e=e.field(o));let t=await e.limit(1).get();if(t.data&&t.data.length>0)return t.data[0]}else console.error("whereJson条件不能为空");return null},baseDao.count=async function(e){let t,{vk:n,db:a,_:i}=util$1,{dbName:r,whereJson:o,foreignDB:s,foreignKey:u,groupJson:l,lastWhereJson:c,db:d}=e,p=d||a;if(n.pubfn.isNotNull(s)||n.pubfn.isNotNull(l)){let e=p.collection(r).aggregate();return n.pubfn.isNotNull(o)&&e.match(o),n.pubfn.isNotNull(l)&&e.group(l),n.pubfn.isNotNull(s)&&(e=baseDao.addForeignDB({foreignDB:s,foreignKey:u,result:e})),n.pubfn.isNotNull(c)&&(e=e.match(c)),e=await e.count("total").end(),e.data[0]?e.data[0].total:0}return t=n.pubfn.isNotNull(o)?await p.collection(r).where(o).count():await p.collection(r).count(),t.total},baseDao.getSelectData=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,whereJson:r,pageIndex:o=1,pageSize:s=DB_PAGE_SIZE,getCount:u=!1,getOne:l=!1,db:c,debug:d=!1}=e;s<0&&(o=1,s=999999999,u=!0),l&&(s=1,u=!1);let p,f,g=c||n,m=e.sortArr,b=e.fieldJson,h=0,y=!1;if(u){let e;d&&(p=Date.now()),e=t.pubfn.isNotNull(r)?await g.collection(i).where(r).count():await g.collection(i).count(),h=e.total,o<Math.ceil(h/s)&&(y=!0),d&&(f=Date.now()-p)}let w=g.collection(i);if(t.pubfn.isNotNull(r)&&(w=w.where(r)),t.pubfn.isNotNull(m))for(let e in m){let t=m[e],n=t.name,a=t.type;null!=a&&""!=a||(a="asc"),w=w.orderBy(n,a)}return{result:w,dbName:i,whereJson:r,pageIndex:o,pageSize:s,getCount:u,sortArr:m,fieldJson:b,total:h,hasMore:y,runTime:f}},baseDao.selectAll=async function(e){let{db:t,_:n,vk:a,config:i}=util$1,{dbName:r,getOne:o=!1,getMain:s=!1,debug:u=!1}=e,l=DB_MAX_LIMIT,c=a.pubfn.getData(i,"vk.db.unicloud.maxLimit");c&&(l=c,(l<=0||l>DB_MAX_LIMIT)&&(l=DB_MAX_LIMIT));let d,p={rows:0,count:0},f=await baseDao.getSelectData(e),{result:g,hasMore:m,total:b,getCount:h,pageIndex:y,pageSize:w,fieldJson:_,runTime:k=0}=f;w>0&&!b&&!h&&(b=w),a.pubfn.isNotNull(_)&&(g=g.field(_));let v,x={};if(h&&0===b)x={data:[]};else{let t=b;w<b&&(t=w);let n=Math.ceil(t/l),a=[],i=(y-1)*w,r=i+w;for(let e=0;e<n;e++){let t=i+e*l,n=l;t+l>r&&(n=r-t);let o=g.skip(t).limit(n).get();a.push(o)}try{u&&(d=Date.now()),x=(await Promise.all(a)).reduce((e,t)=>({data:e.data.concat(t.data),errMsg:e.errMsg})),u&&(p.count=k,p.rows=Date.now()-d,p.total=p.rows+p.count)}catch(t){throw console.error("vk.baseDao.select-异常",e,t),new Error("msg:vk.baseDao.select-异常")}}return u&&(v={runTime:p}),baseDao.returnSelectsRes({rows:x.data,getCount:h,total:b,hasMore:m,pageIndex:y,pageSize:w,getOne:o,getMain:s,needAccurateHasMore:!1,debug:v})},baseDao.sum=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,fieldName:r,whereJson:o,db:s}=e,u=s||n;const l=u.command.aggregate;let c=u.collection(i).aggregate();t.pubfn.isNotNull(o)&&c.match(o),c.group({_id:null,num:l.sum("$"+r)});let d=await c.end();return d.data&&d.data[0]?d.data[0].num:0},baseDao.avg=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,fieldName:r,whereJson:o,db:s}=e,u=s||n;const l=u.command.aggregate;let c=u.collection(i).aggregate();t.pubfn.isNotNull(o)&&c.match(o),c.group({_id:null,num:l.avg("$"+r)});let d=await c.end();return d.data&&d.data[0]?d.data[0].num:null},baseDao.max=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,fieldName:r,whereJson:o,db:s}=e,u=s||n;const l=u.command.aggregate;let c=u.collection(i).aggregate();t.pubfn.isNotNull(o)&&c.match(o),c.group({_id:null,num:l.max("$"+r)});let d=await c.end();return d.data&&d.data[0]?d.data[0].num:null},baseDao.min=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,fieldName:r,whereJson:o,db:s}=e,u=s||n;const l=u.command.aggregate;let c=u.collection(i).aggregate();t.pubfn.isNotNull(o)&&c.match(o),c.group({_id:null,num:l.min("$"+r)});let d=await c.end();return d.data&&d.data[0]?d.data[0].num:null},baseDao.sample=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,whereJson:r,size:o,fieldJson:s,db:u}=e,l=u||n;l.command.aggregate;let c=l.collection(i).aggregate();return t.pubfn.isNotNull(r)&&c.match(r),c.sample({size:o}).limit(o),t.pubfn.isNotNull(s)&&c.project(s),(await c.end()).data},baseDao.selects=async function(e={}){let{vk:t,db:n,_:a}=util$1;if(t.pubfn.isNotNull(e.treeProps))return await baseDao.tree(e);"string"==typeof e.pageIndex&&(e.pageIndex=parseInt(e.pageIndex)),"string"==typeof e.pageSize&&(e.pageSize=parseInt(e.pageSize));let{db:i,dbName:r,foreignKey:o="_id",pageIndex:s=1,pageSize:u=DB_PAGE_SIZE,getCount:l=!1,getOne:c=!1,getMain:d=!1,geoNearJson:p,whereJson:f={},unwindJson:g,groupJson:m,sortArr:b=[],foreignDB:h=[],lastWhereJson:y,lastSortArr:w=[],addFields:_,fieldJson:k={},debug:v=!1,hasMore:x=!1}=e,D=i||n;-1==u&&(s=1,u=999999999,l=!1),c&&(u=1,l=!1),l&&(x=!1);let N,$=0,T=!1,I={rows:0,count:0};if(t.pubfn.isNotNull(f)&&(p=baseDao.createGeoNearJson({geoNearJson:p,whereJson:f})),l){if(v&&(N=Date.now()),t.pubfn.isNullAll(m,g,y,p)){let e;e=t.pubfn.isNotNull(f)?await D.collection(r).where(f).count():await D.collection(r).count(),$=e.total}else{let e=D.collection(r).aggregate();t.pubfn.isNotNull(p)?e=baseDao.getGeoNearJson({runDB:D,result:e,geoNearJson:p,whereJson:f}):t.pubfn.isNotNull(f)&&e.match(f),t.pubfn.isNotNull(g)&&(e=baseDao.getTnwind({result:e,unwindJson:g})),t.pubfn.isNotNull(m)&&e.group(m),t.pubfn.isNotNull(y)&&(t.pubfn.isNotNull(h)&&(e=baseDao.addForeignDB({foreignDB:h,foreignKey:o,result:e})),e.match(y)),e=await e.count("total").end(),$=e.data[0]?e.data[0].total:0}s<Math.ceil($/u)&&(T=!0),v&&(I.count=Date.now()-N)}a.aggregate;let A=D.collection(r).aggregate();A=t.pubfn.isNotNull(p)?baseDao.getGeoNearJson({runDB:D,result:A,geoNearJson:p,whereJson:f}):A.match(f),t.pubfn.isNotNull(g)&&(A=baseDao.getTnwind({result:A,unwindJson:g})),t.pubfn.isNotNull(m)&&(A=A.group(m)),t.pubfn.isNotNull(b)&&(A=baseDao.getSortArr({result:A,sortArr:b}));let S,O=t.pubfn.isNullAll(y,w);if(O){let e=x?u+1:u;A=A.skip((s-1)*u).limit(e)}if(A=baseDao.addForeignDB({foreignDB:h,foreignKey:o,result:A}),t.pubfn.isNotNull(y)&&(A=A.match(y)),t.pubfn.isNotNull(w)&&(A=baseDao.getSortArr({result:A,sortArr:w})),!O){let e=x?u+1:u;A=A.skip((s-1)*u).limit(e)}return t.pubfn.isNotNull(_)&&(A=A.addFields(_)),t.pubfn.isNotNull(k)&&(k=baseDao.foreignDBToProject({fieldJson:k,foreignDB:h,foreignKey:o}),A=A.project(k)),v&&(N=Date.now()),A=await A.end(),v&&(I.rows=Date.now()-N,I.total=I.rows+I.count),v&&(S={runTime:I}),baseDao.returnSelectsRes({rows:A.data,getCount:l,total:$,hasMore:T,pageIndex:s,pageSize:u,getOne:c,getMain:d,needAccurateHasMore:x,debug:S})},baseDao.returnSelectsRes=function(e){let{rows:t,getCount:n,total:a,hasMore:i,pageIndex:r,pageSize:o,getOne:s,getMain:u,needAccurateHasMore:l,debug:c}=e,d={};if(n)d.total=a,d.hasMore=i;else{let e=t?t.length:0;l?e>=o+1?(d.hasMore=!0,t.pop()):d.hasMore=!1:d.hasMore=e>=o,e=t?t.length:0,d.total=(r-1)*o+e}return d.rows=t,d.code=0,d.msg="查询成功",d.pagination={pageIndex:r,pageSize:o},d.getCount=n,c&&(d.debug=c),s&&(d.rows=d.rows[0]),u?d.rows:d},baseDao.listToObjectByLimit1=function(e){let{vk:t,db:n,_:a}=util$1,{list:i,foreignDB:r}=e;if(t.pubfn.isNotNull(r))for(let e in i)for(let n in r){let{as:a,limit:o,foreignDB:s,dbName:u}=r[n];a||(a=u),t.pubfn.isNotNull(s)&&(i[e][a]=baseDao.listToObjectByLimit1({list:i[e][a],foreignDB:s})),1===o&&(t.pubfn.isArray(i[e][a])?i[e][a]&&i[e][a].length>0?i[e][a]=i[e][a][0]:i[e][a]={}:void 0===i[e][a]&&(i[e][a]={}))}return i},baseDao.addForeignDB=function(e){let{vk:t,db:n,_:a}=util$1,{foreignDB:i,foreignKey:r,result:o}=e;const s=a.aggregate;for(let e in i){let n,{dbName:u,foreignKey:l,localKey:c,localKeyType:d="",foreignKeyType:p="",as:f,limit:g,getOne:m,whereJson:b,fieldJson:h,sortArr:y,foreignDB:w,addFields:_}=i[e];f||(f=u),n=t.pubfn.isNotNull(c)?c:"object"==typeof r?r[e]:r;let k,v="string"==typeof n?"$"+n:n,x="string"==typeof l?"$"+l:l,D="$$foreignKey"+baseDao.getForeignKeyName(n),N="foreignKey"+baseDao.getForeignKeyName(n);k="array"===d.toLowerCase()?[s.cond({if:s.isArray(D),then:s.in([x,D]),else:s.eq([x,D])})]:"array"===p.toLowerCase()?[s.cond({if:s.isArray(x),then:s.in([D,x]),else:s.eq([x,D])})]:[s.eq([x,D])];let $=s.pipeline().match(a.expr(s.and(k)));if(t.pubfn.isNotNull(b)&&($=$.match(b)),t.pubfn.isNotNull(y)){let e={};for(let t in y){let n=y[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}$=$.sort(e)}g&&($=$.limit(g)),t.pubfn.isNotNull(w)&&($=baseDao.addForeignDB({foreignDB:w,result:$})),t.pubfn.isNotNull(_)&&($=$.addFields(_)),t.pubfn.isNotNull(h)&&(h=baseDao.foreignDBToProject({fieldJson:h,foreignDB:w}),$=$.project(h)),$=$.done();let T={};T[N]=v;let I={from:u,let:T,pipeline:$,as:f};o=o.lookup(I),(1===g&&!1!==m||!0===m)&&(o=o.unwind({path:"$"+f,preserveNullAndEmptyArrays:!0}))}return o},baseDao.getForeignKeyName=function(e){return"string"==typeof e?e.replace(new RegExp("\\.","g"),"__"):"__vk__foreignKey1"},baseDao.addWhereJson=function(e,t="whereJson"){let{vk:n,db:a,_:i}=util$1,{formData:r,columns:o}=e,s={};for(let e in o){let a,u=o[e],{key:l,mode:c,defaultValue:d,type:p="",lastWhereJson:f,auxiliary:g=!0,trim:m=!0,isNumber:b=!1}=u;if("lastWhereJson"===t&&!f)continue;if("lastWhereJson"!==t&&f)continue;let h=l;if(n.pubfn.isNotNull(u.fieldName)&&(h=u.fieldName),a=n.pubfn.isNotNull(u.value)?u.value:r[l],n.pubfn.isNull(a)&&n.pubfn.isNotNull(d)&&(a=d),n.pubfn.isNull(c)&&(c=["address","province","city","area"].indexOf(p)>-1?"address":"[object Array]"===Object.prototype.toString.call(a)&&a.length>=2?"[]":"="),n.pubfn.isNotNull(a))if("string"==typeof a&&m&&"function"==typeof a.trim&&(a=a.trim()),b&&!isNaN(a)&&(a=Number(a)),"custom"===c);else if("%%"===c)try{s[h]=new RegExp(a)}catch(e){}else if("%*"===c)try{s[h]=new RegExp("^"+a)}catch(e){}else if("*%"===c)try{s[h]=new RegExp(a+"$")}catch(e){}else if(">"===c)s[h]=s[h]?s[h].gt(a):i.gt(a);else if(">="===c)s[h]=s[h]?s[h].gte(a):i.gte(a);else if("<"===c)s[h]=s[h]?s[h].lt(a):i.lt(a);else if("<="===c)s[h]=s[h]?s[h].lte(a):i.lte(a);else if("in"===c)s[h]=i.in(a);else if("nin"===c)s[h]=i.nin(a);else if("!="===c)s[h]=i.neq(a);else if("[]"===c)s[h]=i.gte(a[0]).lte(a[1]);else if("[)"===c)s[h]=i.gte(a[0]).lt(a[1]);else if("(]"===c)s[h]=i.gt(a[0]).lte(a[1]);else if("()"===c)s[h]=i.gt(a[0]).lt(a[1]);else if("address"===c){let e={};a.province&&a.province.code&&(e["province.code"]=a.province.code),a.city&&a.city.code&&(e["city.code"]=a.city.code),a.area&&a.area.code&&(e["area.code"]=a.area.code),s[h]=e}else s[h]=g?"___empty-array___"===a?[]:"___empty-object___"===a?{}:"___non-existent___"===a?i.exists(!1):"___existent___"===a?i.exists(!0):a:a}return s},baseDao.getTableData=async function(e){let{vk:t,db:n,_:a,config:i}=util$1,{db:r,dbName:o,data:s={},getCount:u,getMain:l,geoNearJson:c,whereJson:d,unwindJson:p,fieldJson:f,sortArr:g,treeProps:m,groupJson:b,foreignKey:h,foreignDB:y,lastWhereJson:w,lastSortArr:_,addFields:k,debug:v}=e,{pageIndex:x,pageSize:D,pagination:N,sortRule:$,lastSortRule:T,formData:I,columns:A,getCount:S,total:O}=s;N&&(x=N.pageIndex,D=N.pageSize);let C={},E={},M=[],q={};if(t.pubfn.isNotNull(g))M=g;else{let e=t.pubfn.getData(i,"vk.db.unicloud.getTableData.sortArr");t.pubfn.isNotNull(e)?M=e:M.push({name:"_id",type:"desc"})}t.pubfn.isNotNull($)&&(M=$),t.pubfn.isNotNull(T)&&(_=T),E=baseDao.addWhereJson(s,"whereJson"),q=baseDao.addWhereJson(s,"lastWhereJson"),t.pubfn.isNotNull(d)&&(c=baseDao.createGeoNearJson({geoNearJson:c,whereJson:d}),E=a.and([E,d])),t.pubfn.isNotNull(w)&&(q=a.and([q,w])),t.pubfn.isNotNull(f)&&t.pubfn.objectAssign(C,f);let P={};if(t.pubfn.isNullAll(y,b,m,p,c,k))void 0===u&&(u=!0),!1===S&&(u=!1),P=await t.baseDao.select({db:r,dbName:o,getMain:l,getCount:u,pageIndex:x,pageSize:D,whereJson:E,sortArr:M,fieldJson:C,debug:v,hasMore:!0});else{if(void 0===u){u=!!t.pubfn.isNullAll(q,_)}!1===S&&(u=!1),P=await t.baseDao.selects({db:r,dbName:o,foreignKey:h,getMain:l,getCount:u,pageIndex:x,pageSize:D,geoNearJson:c,whereJson:E,unwindJson:p,treeProps:m,groupJson:b,sortArr:M,foreignDB:y,lastWhereJson:q,lastSortArr:_,addFields:k,fieldJson:C,debug:v,hasMore:!0})}return O&&!1===P.getCount&&(P.total=O),P},baseDao.startTransaction=async function(e){let{vk:t,db:n,_:a}=util$1;return await n.startTransaction()},baseDao.rollbackTransaction=async function(e){let{db:t,msg:n="【异常】操作失败",tips:a="事务已回滚。",err:i={},code:r=-1}=e;console.error("transaction error",i);let o={code:r,msg:n,tips:a};await t.rollback();let s={message:i.message,stack:i.stack};try{s.body=JSON.parse(i.message),"object"==typeof s.body&&void 0!==s.body.code&&(s.body.msg,1)&&(o.msg=s.body.msg)}catch(e){}return console.error("transaction errJson",s),o.err=s,o},baseDao.group=async function(e){let{vk:t,db:n,_:a}=util$1,{dbName:i,whereJson:r,groupJson:o,sortArr:s,pageIndex:u=1,pageSize:l=DB_PAGE_SIZE,getCount:c=!1,lookupJson:d,db:p}=e,f=p||n;l<=0&&(l=999999999);a.aggregate;let g,m=f.collection(i).aggregate();if(t.pubfn.isNotNull(r)&&(m=m.match(r)),t.pubfn.isNotNull(o)&&(m=m.group(o)),t.pubfn.isNotNull(s)){let e={};for(let t in s){let n=s[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}m=m.sort(e)}m=m.skip((u-1)*l).limit(l),t.pubfn.isNotNull(d)&&(g=d.returnObject,delete d.returnObject,m=m.lookup(d)),m=await m.end();let b,h=m.data;if(g)for(let e in h)h[e][d.as]=h[e][d.as][0];let y=!1;if(c){let e=f.collection(i).aggregate();t.pubfn.isNotNull(r)&&(e=e.match(r)),t.pubfn.isNotNull(o)&&(e=e.group(o));let n=await e.count("total").end();b=n.data[0]?n.data[0].total:0,u<Math.ceil(b/l)&&(y=!0)}else b=h?h.length:0,y=b>=l;return{hasMore:y,total:b,rows:h,code:0,key:1,pageIndex:u,pageSize:l}},baseDao.tree=async function(e){let{dbName:t,whereJson:n={},pageIndex:a=1,pageSize:i=DB_PAGE_SIZE,getCount:r=!1,sortArr:o=[],fieldJson:s={},lastWhereJson:u,treeProps:l={},foreignDB:c=[]}=e;e.foreignDB||(e.foreignDB=[]);let{id:d="_id",parent_id:p="parent_id",children:f="children",level:g=10,limit:m=DB_MAX_LIMIT}=l;if(g<1||g>20)throw new Error("msg:treeProps.level的范围必须在[1,20]");delete e.treeProps,e.whereJson||(e.whereJson={[p]:null});let b={dbName:t,localKey:d,foreignKey:p,as:f,limit:m,whereJson:l.whereJson,sortArr:l.sortArr,addFields:l.addFields,fieldJson:l.fieldJson||e.fieldJson,foreignDB:[...e.foreignDB]};const h=function(e,t,n){if(0===t)return e;for(let t=0;t<c.length;t++){let n=c[t];e.push(n)}return e.unshift({...b,foreignDB:h([...e],t-1)}),e};return e.foreignDB=h([],g),await baseDao.selects(e)},baseDao.foreignDBToProject=function(e){let{fieldJson:t,foreignDB:n,foreignKey:a}=e,i=!0;for(let e in t)"_id"==e||t[e]||(i=!1);if(i)for(let e in n){let{as:a,dbName:i}=n[e];a?t[a]=!0:t[i]=!0}return t},baseDao.getTnwind=function(e={}){let{vk:t,db:n,_:a}=util$1,{result:i,unwindJson:r}=e;if(t.pubfn.isNotNull(r)){let{path:e,includeArrayIndex:n,preserveNullAndEmptyArrays:a,replaceRoot:o,unwindWhereJson:s,replaceRootWhereJson:u}=r,l={path:e,includeArrayIndex:n,preserveNullAndEmptyArrays:a};i=i.unwind(l),t.pubfn.isNotNull(s)&&(i=i.match(s)),o&&(i=i.replaceRoot({newRoot:e}),t.pubfn.isNotNull(u)&&(i=i.match(u)))}return i},baseDao.getSortArr=function(e){let{result:t,sortArr:n}=e,a={};for(let e in n){let t=n[e],i=t.name,r=t.type;r=null==r||""==r||"asc"==r?1:-1,a[i]=r}return t=t.sort(a),t},baseDao.getGeoNearJson=function(e){let{runDB:t,result:n,geoNearJson:a,whereJson:i}=e,r=a.keyName,o=a.operands[0];return n=n.geoNear({near:new t.Geo.Point(o.geometry.longitude,o.geometry.latitude),spherical:!0,maxDistance:o.maxDistance,minDistance:o.minDistance,query:i,distanceMultiplier:o.distanceMultiplier,distanceField:o.distanceField||"distance",includeLocs:r,key:r}),n},baseDao.createGeoNearJson=function(e){let{whereJson:t,geoNearJson:n}=e;for(let e in t)if(t[e]&&"object"==typeof t[e])if("geoNear"===t[e].operator)n={...t[e]},n.keyName=e,delete t[e];else if(t[e].val&&t[e].val.geometry&&"Point"===t[e].val.geometry.type){let a=t[e].val;n={operator:"geoNear",operands:[{geometry:{longitude:a.geometry.longitude,latitude:a.geometry.latitude},maxDistance:a.maxDistance,minDistance:a.minDistance,distanceMultiplier:a.distanceMultiplier,distanceField:a.distanceField}],fieldName:{},keyName:e},delete t[e]}return n};var vkBaseDao=baseDao;const request=async(e={})=>{"[object object]"===Object.prototype.toString.call(e.content)&&(e.content=JSON.stringify(e.content)),void 0===e.dataType&&(e.dataType="json"),"default"!=e.dataType&&"buffer"!=e.dataType&&""!==e.dataType||delete e.dataType,e.useContent&&(e.content=JSON.stringify(e.data)),e.method||(e.method="POST"),e.timeout||(e.timeout=6e4),e.method=e.method.toUpperCase(),void 0===e.headers&&void 0!==e.header&&(e.headers=e.header);let t=await uniCloud.httpclient.request(e.url,e);return!e.needOriginalRes&&t&&t.data?t.data:t};var vk_request=request;const callFunction=async(e={})=>{let{name:t,url:n,data:a={},uniIdToken:i,clientInfo:r={},event:o={},uniCloud:s}=e;if(o&&o.originalParam&&o.originalParam.context){let e=o.originalParam.context;i=o.uniIdToken,r={...e,appId:e.APPID,platform:e.PLATFORM,locale:e.LOCALE,clientIP:e.CLIENTIP,os:e.OS,userAgent:e.CLIENTUA,deviceId:e.DEVICEID,uniIdToken:i}}let u,l=s||uniCloud;u=l.$context&&l.$context.FUNCTION_NAME?l.$context.FUNCTION_NAME:l.$options&&l.$options.context&&l.$options.context.FUNCTION_NAME?l.$options.context.FUNCTION_NAME:"router",i||r.uniIdToken&&(i=r.uniIdToken);let c={...a,vk_context:{appId:r.appId,platform:r.platform,locale:r.locale,clientIP:r.clientIP,os:r.os,userAgent:r.userAgent,deviceId:r.deviceId}};t||(t=u);let d=await l.callFunction({name:t,data:{$url:n,uniIdToken:i,data:c}});return d&&d.result};var vk_callFunction=callFunction,util$2={formValidateItem:function(e,t,n){let a={code:0,msg:"ok"},i=getData(e,t);void 0===i&&(i=e[t]);for(let e in n){let r=n[e];if(void 0===i&&r.required){a={type:"undefined",code:-1,msg:"字段："+t+" 名称错误，请检查！",key:t,value:i};break}if(r.required&&(null==i||null==i||""===i||0==i.length)){a={type:"required",code:-1,msg:r.message,key:t,value:i};break}if(r.type&&void 0!==i){if(Object.prototype.toString.call(i).toLowerCase().toLowerCase()!==`[object ${r.type}]`.toLowerCase()){a={type:"type",code:-1,msg:r.message,key:t,value:i};break}}if(r.len&&i.length!=r.len){a={type:"len",code:-1,msg:r.message,key:t,value:i};break}if(r.min&&isNotNull(i))if("number"==r.type){if(i<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:i};break}}else if(i.length<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:i};break}if(r.max&&isNotNull(i))if("number"==r.type){if(i>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:i};break}}else if(i.length>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:i};break}if("function"==typeof r.validator){let e,n,o=0,s=r.validator(r,i,(function(e){return n||(n=e),e}));if(n||(n=s),void 0!==n&&!0!==n&&(o=-1,"object"==typeof n?e||(e=n.message||n.msg,n.code&&(o=n.code)):"string"==typeof n&&(e||(e=n))),o){a={type:"validator",code:o,msg:e||r.message,key:t,value:i};break}}}return a}},formValidate=function(e={}){let t={code:0,msg:"ok"},{data:n,rules:a}=e;if(a)for(let e in a){let i=a[e];if(t=util$2.formValidateItem(n,e,i),0!=t.code)break}return t};function isNotNull(e){return-1===[void 0,null,""].indexOf(e)}function getData(e,t,n){let a=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";let i="";for(let e=0;e<t.length;e++){let n=t.charAt(e);"."!=n&&"["!=n&&"]"!=n?i+=n:a&&(""!=i&&(a=a[i]),i="")}return void 0===a&&void 0!==n&&(a=n),a}function deepClone(e){return JSON.parse(JSON.stringify(e))}var util$3={};function uniqueArr(e){let t=[];for(let n=0;n<e.length;n++)-1==t.indexOf(e[n])&&t.push(e[n]);return t}util$3.treeToArray=function(e,t){let n=deepClone(e);return util$3.treeToArrayFn(n,t)},util$3.treeToArrayFn=function(e,t={},n=[],a){let{id:i="_id",parent_id:r="parent_id",children:o="children",deleteChildren:s=!0}=t;for(let u in e){let l=e[u];a&&(l[r]=a),n.push(l),l[o]&&l[o].length>0&&(n=util$3.treeToArrayFn(l[o],t,n,l[i])),s&&delete l[o]}return n},util$3.arrayToTree=function(e,t){let n=deepClone(e),{id:a="_id",parent_id:i="parent_id",children:r="children",deleteParentId:o=!1,need_field:s}=t,u=[],l={};for(let e=0;e<n.length;e++)l[n[e][a]]=n[e];for(let e=0;e<n.length;e++){let t=n[e];if(s){s=uniqueArr(s.concat([a,i,r]));for(let e in t)-1===s.indexOf(e)&&delete t[e]}let c=l[t[i]];c?(c[r]||(c[r]=[]),o&&delete t[i],c[r].push(t)):u.push(t)}return u};var treeUtil=util$3,util$4={getTargetTimezone:function(e){let t=uniCloud.vk;if("number"==typeof e)return e;let n=8;try{const{config:e}=t.getUnicloud();n=t.pubfn.getData(e.vk,"system.targetTimezone",8)}catch(e){}return n},getDateObject:function(e,t){if(!e)return"";let n;if("string"==typeof e&&!isNaN(e)&&e.length>=10&&(e=Number(e)),"number"==typeof e)10==e.toString().length&&(e*=1e3),n=new Date(e);else if("object"==typeof e)n=new Date(e.getTime());else if("string"==typeof e){let a=t=util$4.getTargetTimezone(t),i=t>=0?"+":"";t>=0&&t<10?a="0"+t:t<0&&t>-10&&(a="-0"+-1*t);let r,o=e.split(" "),s=o[0]||"",u=o[1]||"";r=s.indexOf("-")>-1?s.split("-"):s.split("/");let l=u.split(":"),c={year:Number(r[0]),month:Number(r[1])||1,day:Number(r[2])||1,hour:Number(l[0])||0,minute:Number(l[1])||0,second:Number(l[2])||0};for(let e in c)c[e]>=0&&c[e]<10&&(c[e]="0"+c[e]);let d=`${c.year}-${c.month}-${c.day}T${c.hour}:${c.minute}:${c.second}${i}${a}:00`;n=new Date(d)}return n},getTimeByTimeZone:function(e,t){let n=util$4.getDateObject(e);t=util$4.getTargetTimezone(t);let a=60*n.getTimezoneOffset()*1e3+60*t*60*1e3,i=n.getTime()+a;return n=new Date(i),n},timeFormat:function(e,t="yyyy-MM-dd hh:mm:ss",n){try{if(!e)return"";n=util$4.getTargetTimezone(n);let a=util$4.getTimeByTimeZone(e,n),i={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds(),Z:`${n>=0?"+":"-"}${Math.abs(n).toString().padStart(2,"0")}:00`},r=new RegExp("(y+)");if(r.test(t)){let e=t.match(r);t=t.replace(e[1],(a.getFullYear()+"").substr(4-e[1].length))}for(let e in i){let n=new RegExp("("+e+")");if(n.test(t)){let a=t.match(n);t=t.replace(a[1],1==a[1].length?i[e]:("00"+i[e]).substr((""+i[e]).length))}}return t}catch(e){return time}},getDateInfo:function(e=new Date,t){let n=util$4.getTimeByTimeZone(e,t),a=n.getFullYear()+"",i=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,r=n.getDate()<10?"0"+n.getDate():n.getDate(),o=n.getHours()<10?"0"+n.getHours():n.getHours(),s=n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes(),u=n.getSeconds()<10?"0"+n.getSeconds():n.getSeconds(),l=n.getMilliseconds(),c=n.getDay(),d=Math.floor((n.getMonth()+3)/3);return{year:Number(a),month:Number(i),day:Number(r),hour:Number(o),minute:Number(s),second:Number(u),millisecond:Number(l),week:Number(c),quarter:Number(d)}},getCommonTime:function(e=new Date,t){let n={},a=util$4.getDateObject(e);t=util$4.getTargetTimezone(t);const i=60*a.getTimezoneOffset()*1e3+60*t*60*1e3,{year:r,month:o,day:s,hour:u,minute:l,second:c,millisecond:d,week:p,quarter:f}=util$4.getDateInfo(a,t);n.now={year:r,month:o,day:s,hour:u,minute:l,second:c,millisecond:d,week:p,quarter:f,date_str:util$4.timeFormat(a,"yyyy-MM-dd hh:mm:ss",t),date_day_str:util$4.timeFormat(a,"yyyy-MM-dd",t),date_month_str:util$4.timeFormat(a,"yyyy-MM",t)};let g=new Date(r,o,0).getDate(),m=new Date(r,12,0).getDate();n.todayStart=new Date(`${r}/${o}/${s}`).getTime()-i,n.today12End=new Date(`${r}/${o}/${s}`).getTime()+43199999-i,n.todayEnd=new Date(`${r}/${o}/${s}`).getTime()+86399999-i,n.monthStart=new Date(`${r}/${o}/1`).getTime()-i,n.monthEnd=new Date(`${r}/${o}/${g}`).getTime()+86399999-i,n.yearStart=new Date(r+"/1/1").getTime()-i,n.yearEnd=new Date(`${r}/12/${m}`).getTime()+86399999-i,n.hourStart=new Date(`${r}/${o}/${s} ${u}:00:00`).getTime()-i,n.hourEnd=new Date(`${r}/${o}/${s} ${u}:59:59`).getTime()-i;let b=r,h=o-1;0===h&&(h=12,b=r-1);let y=new Date(b,h,0).getDate();n.lastMonthStart=new Date(`${b}/${h}/1`).getTime()-i,n.lastMonthEnd=new Date(`${b}/${h}/${y}`).getTime()+86399999-i,n.yesterdayStart=n.todayStart-864e5,n.yesterday12End=n.today12End-864e5,n.yesterdayEnd=n.todayEnd-864e5;let w=util$4.getWeekOffsetStartAndEnd(0,a,t);n.weekStart=w.startTime,n.weekEnd=w.endTime,n.months=[],n.months[0]={startTime:n.monthStart,endTime:n.monthEnd,startTimeStr:util$4.timeFormat(n.monthStart,"yyyy-MM-dd hh:mm:ss",t),endTimeStr:util$4.timeFormat(n.monthEnd,"yyyy-MM-dd hh:mm:ss",t),monthStart:n.monthStart,monthEnd:n.monthEnd};for(let e=1;e<=12;e++){let a=new Date(r,e,0).getDate(),o=new Date(`${r}/${e}/1`).getTime()-i,s=new Date(`${r}/${e}/${a}`).getTime()+86399999-i;n.months[e]={startTime:o,endTime:s,startTimeStr:util$4.timeFormat(o,"yyyy-MM-dd hh:mm:ss",t),endTimeStr:util$4.timeFormat(s,"yyyy-MM-dd hh:mm:ss",t),monthStart:o,monthEnd:s}}n.days=[],n.days[0]={startTime:n.todayStart,endTime:n.todayEnd,startTimeStr:util$4.timeFormat(n.todayStart,"yyyy-MM-dd hh:mm:ss",t),endTimeStr:util$4.timeFormat(n.todayEnd,"yyyy-MM-dd hh:mm:ss",t)};for(let e=1;e<=g;e++){let a=n.monthStart+864e5*(e-1),{startTime:i,endTime:r}=util$4.getDayOffsetStartAndEnd(0,a,t);n.days[e]={startTime:i,endTime:r,startTimeStr:util$4.timeFormat(i,"yyyy-MM-dd hh:mm:ss",t),endTimeStr:util$4.timeFormat(r,"yyyy-MM-dd hh:mm:ss",t)}}for(let e in n)"number"==typeof n[e]&&13===n[e].toString().length&&(n[e+"Str"]=util$4.timeFormat(n[e],"yyyy-MM-dd hh:mm:ss",t));return n},getMonthStartAndEnd:function(e,t){t=util$4.getTargetTimezone(t);let n={startTime:null,endTime:null},{year:a,month:i}=e;if(a>0&&i>0){const e=60*(new Date).getTimezoneOffset()*1e3+60*t*60*1e3;let r=new Date(a,i,0).getDate();n.startTime=new Date(`${a}/${i}/1`).getTime()-e,n.endTime=new Date(`${a}/${i}/${r}`).getTime()+86399999-e}return n},getHourOffsetStartAndEnd:function(e=0,t=new Date,n){let a=util$4.getDateObject(t);n=util$4.getTargetTimezone(n);let i={};const r=60*a.getTimezoneOffset()*1e3+60*n*60*1e3;a=new Date(a.getTime()+36e5*e);let o=util$4.getDateInfo(a);return i.startTime=new Date(`${o.year}/${o.month}/${o.day} ${o.hour}:00:00`).getTime()-r,i.endTime=new Date(`${o.year}/${o.month}/${o.day} ${o.hour}:00:00`).getTime()+3599999-r,i},getDayOffsetStartAndEnd:function(e=0,t=new Date,n){let a=util$4.getDateObject(t);n=util$4.getTargetTimezone(n);let i={};const r=60*a.getTimezoneOffset()*1e3+60*n*60*1e3;a=new Date(a.getTime()+864e5*e);let o=util$4.getDateInfo(a);return i.startTime=new Date(`${o.year}/${o.month}/${o.day}`).getTime()-r,i.endTime=new Date(`${o.year}/${o.month}/${o.day}`).getTime()+86399999-r,i},getWeekOffsetStartAndEnd:function(e=0,t=new Date,n){let a={},i=util$4.getDateObject(t);n=util$4.getTargetTimezone(n);const r=60*i.getTimezoneOffset()*1e3+60*n*60*1e3;let o=0===i.getDay()?7:i.getDay();i.setDate(i.getDate()-o+1+7*e);let s=util$4.getDateInfo(i);i.setDate(i.getDate()+7);let u=util$4.getDateInfo(i);return a.startTime=new Date(`${s.year}/${s.month}/${s.day}`).getTime()-r,a.endTime=new Date(`${u.year}/${u.month}/${u.day}`).getTime()-1-r,a},getMonthOffsetStartAndEnd:function(e=0,t=new Date,n){let a={},i=util$4.getDateObject(t),r=util$4.getDateInfo(i),o=r.month+e,s=r.year;o>12?(s+=Math.floor(o/12),o=Math.abs(o)%12):o<=0&&(s=s-1-Math.floor(Math.abs(o)/12),o=12-Math.abs(o)%12);let u=new Date(s,o,0).getDate();return a.startTime=util$4.getDateObject(`${s}/${o}/01`,n).getTime(),a.endTime=util$4.getDateObject(`${s}/${o}/${u}`,n).getTime()+86399999,a},getQuarterOffsetStartAndEnd:function(e=0,t=new Date,n){let a={},i=util$4.getDateObject(t);i.setMonth(i.getMonth()+3*e),n=util$4.getTargetTimezone(n);const r=60*i.getTimezoneOffset()*1e3+60*n*60*1e3;let o=util$4.getDateInfo(i).month;[1,2,3].indexOf(o)>-1?o=1:[4,5,6].indexOf(o)>-1?o=4:[7,8,9].indexOf(o)>-1?o=7:[10,11,12].indexOf(o)>-1&&(o=10),i.setMonth(o-1);let s=util$4.getDateInfo(i);i.setMonth(i.getMonth()+3);let u=util$4.getDateInfo(i);return a.startTime=new Date(`${s.year}/${s.month}/1`).getTime()-r,a.endTime=new Date(`${u.year}/${u.month}/1`).getTime()-1-r,a},getYearOffsetStartAndEnd:function(e=0,t=new Date,n){let a={},i=util$4.getDateObject(t);n=util$4.getTargetTimezone(n);const r=60*i.getTimezoneOffset()*1e3+60*n*60*1e3;let o=util$4.getDateInfo(i).year+e;return a.startTime=new Date(o+"/1/1").getTime()-r,a.endTime=new Date(o+"/12/31").getTime()+86399999-r,a},getOffsetTime:function(e=new Date,t,n){let a=util$4.getDateObject(e),i=util$4.getDateInfo(a);n=util$4.getTargetTimezone(n);const r=60*a.getTimezoneOffset()*1e3+60*n*60*1e3;let o=t.year||t.y||0,s=t.month||t.m||0,u=t.day||t.d||0,l=t.hour||t.hours||t.hh||0,c=t.minute||t.minutes||t.mm||0,d=t.second||t.seconds||t.ss||0,{mode:p="after"}=t;"before"==p&&(o*=-1,s*=-1,u*=-1,l*=-1,c*=-1,d*=-1);let f={year:i.year+o,month:i.month+s,day:i.day+u,hour:i.hour+l,minute:i.minute+c,second:i.second+d};return a=new Date(f.year,f.month-1,f.day,f.hour,f.minute,f.second),a.getTime()-r},isLeapYear:function(e){if(void 0===e){let{now:t}=util$4.getCommonTime();e=t.year}else if("object"==typeof e){let{now:t}=util$4.getCommonTime(e);e=t.year}return e%4==0&&e%100!=0||e%400==0},isQingming:function(e=new Date){let{now:t}=util$4.getCommonTime(e),{year:n,month:a,day:i}=t,r=!1;return util$4.isLeapYear(n)||util$4.isLeapYear(n-1)?4===a&&4===i&&(r=!0):4===a&&5===i&&(r=!0),r},getFullTime:function(e,t=0,n){if(!e)return"";n=util$4.getTargetTimezone(n);let a=util$4.getDateObject(e);const i=60*a.getTimezoneOffset()*1e3+60*n*60*1e3,r=a.getTime()+i;a=new Date(r);let o=a.getFullYear()+"",s=a.getMonth()+1<10?"0"+(a.getMonth()+1):a.getMonth()+1,u=a.getDate()<10?"0"+a.getDate():a.getDate(),l=a.getHours()<10?"0"+a.getHours():a.getHours(),c=a.getMinutes()<10?"0"+a.getMinutes():a.getMinutes(),d=a.getSeconds()<10?"0"+a.getSeconds():a.getSeconds();return 2===t?{YYYY:Number(o),MM:Number(s),DD:Number(u),hh:Number(l),mm:Number(c),ss:Number(d),year:Number(o),month:Number(s),day:Number(u),hour:Number(l),minute:Number(c),second:Number(d)}:1===t?o+""+s+u+l+c+d:o+"-"+s+"-"+u+" "+l+":"+c+":"+d}},timeUtil=util$4,pubfn={};pubfn.formValidate=formValidate,pubfn.treeUtil=treeUtil,pubfn.timeUtil=timeUtil,pubfn.sleep=e=>new Promise(t=>setTimeout(t,e)),pubfn.timeFormat=pubfn.timeUtil.timeFormat,pubfn.getDateInfo=pubfn.timeUtil.getDateInfo,pubfn.getFullTime=pubfn.timeUtil.getFullTime,pubfn.getCommonTime=pubfn.timeUtil.getCommonTime,pubfn.getOffsetTime=pubfn.timeUtil.getOffsetTime,pubfn.getHourOffsetStartAndEnd=pubfn.timeUtil.getHourOffsetStartAndEnd,pubfn.getDayOffsetStartAndEnd=pubfn.timeUtil.getDayOffsetStartAndEnd,pubfn.getWeekOffsetStartAndEnd=pubfn.timeUtil.getWeekOffsetStartAndEnd,pubfn.getWeekStartAndEnd=pubfn.timeUtil.getWeekOffsetStartAndEnd,pubfn.getMonthOffsetStartAndEnd=pubfn.timeUtil.getMonthOffsetStartAndEnd,pubfn.getQuarterOffsetStartAndEnd=pubfn.timeUtil.getQuarterOffsetStartAndEnd,pubfn.getYearOffsetStartAndEnd=pubfn.timeUtil.getYearOffsetStartAndEnd,pubfn.getMonthStartAndEnd=pubfn.timeUtil.getMonthStartAndEnd,pubfn.validator=function(e){return function(t,n,a){let i=pubfn.test(n,e);return"function"!=typeof a||!i&&n?a(!1):void a()}},pubfn.test=function(e,t="",n=!1){let a;if(t=t.toLowerCase(),n&&(""===e||null==e))return!0;switch(t){case"mobile":return new RegExp(/^1[3|4|5|6|7|8|9][0-9]{9}$/).test(e);case"tel":return new RegExp(/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/).test(e);case"card":return new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/).test(e);case"mobilecode":return new RegExp(/^[0-9]{6}$/).test(e);case"username":return new RegExp(/^[a-zA-Z]([-_a-zA-Z0-9]{2,31})$/).test(e);case"pwd":case"password":return new RegExp(/^([a-zA-Z0-9_@]){6,18}$/).test(e);case"paypwd":return new RegExp(/^[0-9]{6}$/).test(e);case"postal":return new RegExp(/[1-9]\d{5}(?!\d)/).test(e);case"qq":return new RegExp(/^[1-9][0-9]{4,9}$/).test(e);case"email":return new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/).test(e);case"money":return new RegExp(/^\d*(?:\.\d{0,2})?$/).test(e);case"url":return new RegExp(/^(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/).test(e);case"ip":return new RegExp(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/).test(e);case"date":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/).test(e);case"time":return new RegExp(/^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"datetime":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"english+number":return new RegExp(/^[a-zA-Z0-9]+$/).test(e);case"english+number+_":return new RegExp(/^[a-zA-Z0-9_]+$/).test(e);case"english+number+_-":return new RegExp(/^[a-zA-Z0-9_-]+$/).test(e);case"version":return new RegExp(/^([1-9]\d|[1-9])(.([1-9]\d|\d)){2}$/).test(e);case"number":return new RegExp(/^[0-9]+$/).test(e);case"english":return new RegExp(/^[a-zA-Z]+$/).test(e);case"chinese":return new RegExp(/^[\u4e00-\u9fa5]+$/gi).test(e);case"lower":return new RegExp(/^[a-z]+$/).test(e);case"upper":return new RegExp(/^[A-Z]+$/).test(e);case"html":return new RegExp(/<("[^"]*"|'[^']*'|[^'">])*>/).test(e);case"image":return a=e.split("?")[0],new RegExp(/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)$/).test(a);case"video":return a=e.split("?")[0],new RegExp(/\.(mp4|mpg|mpeg|dat|asf|avi|rm|rmvb|mov|wmv|flv|mkv|m3u8|3gp)$/).test(a);case"audio":return a=e.split("?")[0],new RegExp(/\.(mp3)$/).test(a);default:return!0}},pubfn.checkStr=pubfn.test,pubfn.priceFilter=function(e,t=""){return pubfn.isNull(e)?t:isNaN(e)?e:("string"==typeof e&&(e=parseFloat(e)),(e/100).toFixed(2))},pubfn.priceLeftFilter=function(e){let t="";return e&&(t=pubfn.priceFilter(e).split(".")[0]),t},pubfn.priceRightFilter=function(e){let t="";return e&&(t=pubfn.priceFilter(e).split(".")[1]),t},pubfn.percentageFilter=function(e,t=!0,n=""){return pubfn.isNull(e)?n:(isNaN(e)||("string"==typeof e&&(e=parseFloat(e)),e=parseFloat((100*e).toFixed(2)),t&&(e+="%")),e)},pubfn.discountFilter=function(e,t=!0,n=""){return pubfn.isNull(e)?n:isNaN(e)?e:("string"==typeof e&&(e=parseFloat(e)),(e=parseFloat((10*e).toFixed(2)))>10?"折扣不可以大于原价":10==e?"原价":0==e?"免费":e<0?"折扣不可以小于0":(t&&(e+=" 折"),e))},pubfn.objectDeleteInvalid=function(e){return Object.keys(e).forEach(t=>{void 0===e[t]&&delete e[t]}),e},pubfn.objectAssign=function(e,t,n=!0){return n&&pubfn.objectDeleteInvalid(t),Object.assign(e,t)},pubfn.copyObject=function(e){return void 0!==e?JSON.parse(JSON.stringify(e)):e},pubfn.deepClone=function(e){if([null,void 0,NaN,!1].includes(e))return e;if("object"!=typeof e&&"function"!=typeof e)return e;let t="[object Array]"===Object.prototype.toString.call(e)?[]:{};for(let n in e)e.hasOwnProperty(n)&&(t[n]="object"==typeof e[n]?pubfn.deepClone(e[n]):e[n]);return t},pubfn.formAssign=function(e,t){let n=pubfn.copyObject(e);return pubfn.objectAssign(n,t)},pubfn.arr_concat=function(e,t,n){n||(n="id"),e||(e=[]),t||(t=[]);let a=e.concat(t),i=[];if(-1!=n){let e=[];for(let t in a)-1==e.indexOf(a[t][n])&&(e.push(a[t][n]),i.push(a[t]))}else i=a;return i},pubfn.getData=function(e,t,n){let a=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";let i="";for(let e=0;e<t.length;e++){let n=t.charAt(e);"."!=n&&"["!=n&&"]"!=n?i+=n:a&&(""!=i&&(a=a[i]),i="")}return void 0===a&&void 0!==n&&(a=n),a},pubfn.setData=function(e,t,n){let a;a="object"==typeof n?pubfn.copyObject(n):n;let i=new RegExp("([\\w$-]+)|\\[(:\\d)\\]","g");const r=t.match(i);for(let t=0;t<r.length-1;t++){let n=r[t];"object"!=typeof e[n]&&(e[n]={}),e=e[n]}e[r[r.length-1]]=a},pubfn.isNull=function(e){let t=!1;return void 0!==e&&"[object Null]"!=Object.prototype.toString.call(e)&&""!==e&&"{}"!=JSON.stringify(e)&&"[]"!=JSON.stringify(e)&&void 0!==JSON.stringify(e)||(t=!0),t},pubfn.isNotNull=function(e){return!pubfn.isNull(e)},pubfn.isNullOne=function(...e){let t=!1;for(let n=0;n<e.length;n++){let a=e[n];if(pubfn.isNull(a)){t=!0;break}}return t},pubfn.isNullOneByObject=function(e){let t;for(let n in e){let a=e[n];if(pubfn.isNull(a)){t=n;break}}return t},pubfn.isNullAll=function(...e){let t=!0;for(let n=0;n<e.length;n++){let a=e[n];if(pubfn.isNotNull(a)){t=!1;break}}return t},pubfn.isNotNullAll=function(...e){return!pubfn.isNullOne(...e)},pubfn.getListItem=function(e,t,n){let a;for(let i=0;i<e.length;i++)if(e[i][t]===n){a=e[i];break}return a},pubfn.getListIndex=function(e,t,n){let a=-1;for(let i=0;i<e.length;i++)if(e[i][t]===n){a=i;break}return a},pubfn.getListItemIndex=function(e,t,n){let a,i={},r=-1;for(let i=0;i<e.length;i++)if(e[i][t]===n){r=i,a=e[i];break}return i={item:a,index:r},i},pubfn.arrayToJson=function(e,t){let n={};for(let a in e){let i=e[a];n[i[t]]=i}return n},pubfn.listToJson=pubfn.arrayToJson,pubfn.arrayObjectGetArray=function(e,t){return e.map(e=>e[t])},pubfn.random=function(e,t,n){let a;if(pubfn.isNull(n))a=pubfn.randomFn(e,t);else{let i=0,r=1e5;do{i++,a=pubfn.randomFn(e,t)}while(n.indexOf(a)>-1&&i<r);i===r&&(a=void 0)}return a},pubfn.randomFn=function(e,t){let n="",a="123456789";pubfn.isNotNull(t)&&("a-z,0-9"==t?t="abcdefghijklmnopqrstuvwxyz0123456789":"A-Z,0-9"==t?t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"a-z,A-Z,0-9"!=t&&"A-Z,a-z,0-9"!=t||(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),a=t);for(let t=0;t<e;t++){n+=a[Math.floor(Math.random()*a.length)]}return n},pubfn.stringIdToNumberId=function(e,t){let n="",a=e.split("").reverse().join("");for(let e=0;e<t;e++)if(a.length>e){n+="0123456789"[a[e].charCodeAt()%10]}else n="0"+n;return n},pubfn.hidden=function(e="",t=0,n=0){let a=e.length-t-n,i="";for(let e=0;e<a;e++)i+="*";return e.substring(0,t)+i+e.substring(e.length-n)},pubfn.checkArrayIntersection=function(e=[],t=[]){let n=!1;for(let a=0;a<t.length;a++)e.indexOf(t[a])>-1&&(n=!0);return n},pubfn.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},pubfn.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},pubfn.calcFreights=function(e,t){return pubfn.calcFreightDetail(e,t).total_amount},pubfn.calcFreightDetail=function(e,t){let{first_weight:n,first_weight_price:a,continuous_weight:i,continuous_weight_price:r,max_weight:o}=e;o||(o=1e9);let s=t,u=0,l=o,c=!1,d=0;for(;t>0;)c?(d++,t-=i,l-=i):(c=!0,u++,l=o,t-=n,l-=n),l<=0&&(c=!1);let p=a*u+r*d;return{weight:s,first_weight:n,first_weight_price:a,first_weight_count:u,continuous_weight:i,continuous_weight_price:r,continuous_weight_count:d,first_weight_amount:u*a,continuous_weight_amount:r*d,total_amount:p,formula:`${a} * ${u} + ${r} * ${d} = ${p}`}},pubfn.getNewObject=function(e,t){let n=pubfn.copyObject(e),a={};if(t&&t.length>0)for(let e in t){let i=t[e];pubfn.isNotNull(n[i])&&(a[i]=n[i])}else a=n;return a},pubfn.deleteObjectKeys=function(e,t=[]){var n={};if(e)for(let a in e)-1==t.indexOf(a)&&(n[a]=e[a]);return n},pubfn.arrayToTree=pubfn.treeUtil.arrayToTree,pubfn.treeToArray=pubfn.treeUtil.treeToArray,pubfn.wildcardTestOne=function(e,t){if(!t)return!1;let n=t.replace(new RegExp("\\*"),"(.*)"),a=0!==t.indexOf("*")?"^":"",i="*"!==t[t.length-1]?"$":"";return new RegExp(a+n+i).test(e)},pubfn.wildcardTest=function(e,t){let n=0;if("string"==typeof t)pubfn.wildcardTestOne(e,t)&&n++;else if("object"==typeof t)for(let a=0;a<t.length;a++){let i=t[a];pubfn.wildcardTestOne(e,i)&&n++}return n},pubfn.regExpTestOne=function(e,t){if(!t)return!1;return new RegExp(t).test(e)},pubfn.regExpTest=function(e,t){let n=0;if("string"==typeof t)pubfn.regExpTestOne(e,t)&&n++;else if("object"==typeof t)for(let a=0;a<t.length;a++){let i=t[a];pubfn.regExpTestOne(e,i)&&n++}return n},pubfn.regExpExecToTemplate=function(e,t,n){let a=new RegExp(t).exec(e);if(a){for(let e=1;e<a.length;e++)n=n.replace("$"+e,a[e]);return n}},pubfn.createOrderNo=function(e="",t=25){let n=pubfn.timeFormat(new Date,"yyyyMMddhhmmss");n=n.substring(2);let a=t-(e+n).length;return e+n+pubfn.random(a)},pubfn.dateDiff=function(e,t="前"){if(!e)return"";"string"!=typeof e||isNaN(e)||(e=Number(e)),"number"==typeof e&&(10==e.toString().length&&(e*=1e3),e=new Date(e),e=pubfn.timeFormat(e)),"string"==typeof e&&(e=e=e.replace("T"," "),e=new Date(e.replace(/-/g,"/")));var n=864e5,a=36e5,i=(new Date).getTime()-e.getTime(),r=Math.floor(i/n),o=Math.floor(i%n/a),s=Math.floor(i%n%a/6e4),u=Math.round(i%n%a%6e4/1e3),l="1 秒";return r>0?l=r+"天":o>0?l=o+"小时":s>0?l=s+"分钟":u>0&&(l=u+"秒"),l+=t},pubfn.dateDiff2=function(e,t="1秒"){if(!e)return"";"string"!=typeof e||isNaN(e)||(e=Number(e)),"number"==typeof e&&(10==e.toString().length&&(e*=1e3),e=new Date(e),e=pubfn.timeFormat(e)),"string"==typeof e&&(e=e=e.replace("T"," "),e=new Date(e.replace(/-/g,"/")));var n=new Date,a=864e5,i=36e5,r=e.getTime()-n.getTime(),o=Math.floor(r/a),s=Math.floor(r%a/i),u=Math.floor(r%a%i/6e4),l=Math.round(r%a%i%6e4/1e3),c=t;return o>0?c=o+"天":s>0?c=s+"小时":u>0?c=u+"分钟":l>0&&(c=l+"秒"),c},pubfn.numStr=function(e){"string"==typeof e&&(e=parseFloat(e));var t=e;if(e<1e3)t=e;else if(e<1e4){t=Math.floor(e/100)/10+"千"}else if(e<1e6){t=Math.floor(e/1e3)/10+"万"}else if(e<1e7){t=Math.floor(e/1e6)+"百万"}else if(e<1e8){t=Math.floor(e/1e7)+"千万"}else if(e>=1e8){t=Math.floor(e/1e7)/10+"亿"}return t},pubfn.calcSize=function(e=0,t,n,a=2,i="auto"){let r=0,o="";if((e=parseFloat(e))<n||t.length<=1)o=t[0],r=parseFloat(e.toFixed(a));else for(let s=1;s<t.length;s++){let u=t[s];if(e/=n,"auto"===i){if(e<n){o=u,r=parseFloat(e.toFixed(a));break}}else if(i===u){o=u,r=parseFloat(e.toFixed(a));break}}return{size:r,type:o,title:r+" "+o}};const isSnakeCase=new RegExp("_(\\w)","g"),isCamelCase=new RegExp("[A-Z]","g");function parseObjectKeys(e,t){let n,a;switch(t){case"snake2camel":a=pubfn.snake2camel,n=isSnakeCase;break;case"camel2snake":a=pubfn.camel2snake,n=isCamelCase}for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&n.test(i)){const n=a(i);e[n]=e[i],delete e[i],"[object Object]"===Object.prototype.toString.call(e[n])?e[n]=parseObjectKeys(e[n],t):Array.isArray(e[n])&&(e[n]=e[n].map(e=>parseObjectKeys(e,t)))}return e}pubfn.snake2camel=function(e){return e.replace(isSnakeCase,(e,t)=>t?t.toUpperCase():"")},pubfn.camel2snake=function(e){return e.replace(isCamelCase,e=>"_"+e.toLowerCase())},pubfn.snake2camelJson=function(e){return parseObjectKeys(e,"snake2camel")},pubfn.camel2snakeJson=function(e){return parseObjectKeys(e,"camel2snake")},pubfn.string2Number=function(e,t={}){switch(Object.prototype.toString.call(e).slice(8,-1).toLowerCase()){case"string":if(e&&!isNaN(e)){let{mobile:n=!0,idCard:a=!0,startFrom0:i=!0,maxLength:r=14}=t;return e.length>r||(n&&pubfn.test(e,"mobile")||a&&pubfn.test(e,"card")||i&&e.length>1&&0===e.indexOf("0")&&1!==e.indexOf("."))?e:Number(e)}return e;case"object":const n=Object.keys(e);for(let t=0;t<n.length;t++){const a=n[t];e[a]=pubfn.string2Number(e[a])}return e;case"array":for(let t=0;t<e.length;t++)e[t]=pubfn.string2Number(e[t]);return e;default:return e}},pubfn.toDecimal=function(e,t=0){return"string"==typeof e&&(e=Number(e)),parseFloat(e.toFixed(t))},pubfn.getFileType=function(e){let t;return t=pubfn.checkFileSuffix(e,["png","jpg","jpeg","gif","bmp","svg"])?"image":pubfn.checkFileSuffix(e,["avi","mp4","3gp","mov","rmvb","rm","flv","mkv"])?"video":pubfn.checkFileSuffix(e,["mp3"])?"audio":"other",t},pubfn.getFileSuffix=function(e){let t,n=e.lastIndexOf(".");return n>-1&&(t=e.substring(n+1)),t},pubfn.checkFileSuffix=function(e,t){let n=!1,a=pubfn.getFileSuffix(e);for(let e=0;e<t.length;e++)if(t.indexOf(a)>-1){n=!0;break}return n},pubfn.splitArray=function(e,t){let n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n},pubfn.objectKeySort=function(e){let t=Object.keys(e).sort(),n={};for(let a in t)n[t[a]]=e[t[a]];return n},pubfn.urlStringToJson=function(e){let t={};if(""!=e&&null!=e&&null!=e){let n=e.split("&");for(let e=0;e<n.length;e++){let a=n[e].split("="),i=a[0],r=a[1];t[i]=r}}return t},pubfn.jsonToUrlString=function(e){let t="";for(let n in e)if(e.hasOwnProperty(n)){""!==t&&(t+="&"),t+=n+"="+e[n]}return t},pubfn.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(console.log("event.path:",e.path),e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.url=t.$url||"",t},pubfn.stringToFormData=function(e){e||(e="");for(var t=e.split("Content-Disposition: form-data;"),n={},a=0;a<t.length;a++){var i=t[a];let e='name="';var r=i.indexOf(e)+e.length;if(r>-1){var o=i.indexOf('"',r),s=i.substring(r,o);if(o>r){var u=i.indexOf("---",o),l=i.substring(o+1,u).trim();n[s]=l}}}return n},pubfn.getPlatform=function(e){return"web"===e?e="h5":"app"===e&&(e="app-plus"),e},pubfn.getClientUAByContext=function(e={}){return e.ua||e.CLIENTUA},pubfn.getPlatformForUniId=function(e={}){let t=e.PLATFORM;if(t=pubfn.getPlatform(t),"h5"===t){pubfn.getClientUAByContext(e).toLowerCase().indexOf("micromessenger")>-1&&(t="h5-weixin")}return t},pubfn.getUniCloudContext=function(){let e;try{e=uniCloud.context}catch(e){}return e},pubfn.getUniCloudFunctionName=function(){let e;try{let t=pubfn.getUniCloudContext();e=t.FUNCTION_NAME||t.function_name}catch(e){}return e},pubfn.getUniCloudProvider=function(){let e;try{e=uniCloud.getCloudInfos()[0].provider}catch(e){}return e},pubfn.getUniCloudRequestId=function(){let e;try{e=pubfn.getUniCloudContext().requestId}catch(e){}return e},pubfn.getUniIdConfig=function(e={},t,n){const a=e.uni;let i;if(pubfn.isArray(a)){let e;if(uniCloud.env&&uniCloud.env.APPID)e=uniCloud.env.APPID;else if(uniCloud.$context&&uniCloud.$context.APPID)e=uniCloud.$context.APPID;else{let t=uniCloud.getClientInfos()[0];t.appId&&(e=t.appId)}i=pubfn.getListItem(a,"dcloudAppid",e),pubfn.isNull(i)&&(i=pubfn.getListItem(a,"isDefaultConfig",!0))}else i=a;if(pubfn.isNotNull(t)){let e=pubfn.getData(i,t);return pubfn.isNull(e)?n:e}return i},pubfn.batchRun=async function(e){let{main:t,data:n=[],concurrency:a=50}=e;if(pubfn.isArray(t))return pubfn.batchRun2(e);let i=n.length,r=[];if(0==i)return{stack:r,total:i};if(1===a){for(let e=0;e<i;e++)try{let a=await t(n[e],e);r.push(a)}catch(e){r.push(e)}return{stack:r,total:i}}{let e=Math.ceil(i/a);for(let o=0;o<e;o++){let e=[];for(let r=0;r<a;r++){let s=o*a+r;if(s>=i)break;let u=t(n[s],s);e.push(u)}try{await Promise.all(e).then(e=>{r=r.concat(e)})}catch(e){console.error(e)}}return{stack:r,total:i}}},pubfn.batchRun2=async function(e){let{main:t,concurrency:n=100}=e,a=t.length,i=[];if(0==a)return{stack:i,total:a};if(1===n){for(let e=0;e<a;e++)try{let n=t[e],a=await n();i.push(a)}catch(e){i.push(e)}return{stack:i,total:a}}{let e=Math.ceil(a/n);for(let r=0;r<e;r++){let e=[];for(let i=0;i<n;i++){let o=r*n+i;if(o>=a)break;let s=(0,t[o])();e.push(s)}try{await Promise.all(e).then(e=>{i=i.concat(e)})}catch(e){console.error(e)}}return{stack:i,total:a}}},pubfn.randomAsync=async function(e,t,n,a=500){let i;if("function"==typeof n){let r=0;do{r++,i=pubfn.randomFn(e,t)}while(!await n(i)&&r<a);r===a&&(i=void 0),await n(i)}else i=pubfn.randomFn(e,t);return i},pubfn.checkModule=function(e){let t=uniCloud.vk.require("package.json");return!(!t.extensions||!t.extensions[e])||!(!t.dependencies||!t.dependencies[e])};var _function=pubfn,util$5={},dataCache={};util$5.get=function(e){let t,n=dataCache[e];if(n){let{value:a,expired:i}=n;util$5.isExpired(e)?delete dataCache[e]:t=a}return t},util$5.set=function(e,t,n=0){let a={value:t,expired:n>0?(new Date).getTime()+1e3*n:0};dataCache[e]=a},util$5.del=function(e){delete dataCache[e]},util$5.clear=function(e){if(e)for(let t in dataCache)0==t.indexOf(e)&&delete dataCache[t];else dataCache={}},util$5.isExpired=function(e){let t=!0,n=dataCache[e];return n&&(0==n.expired||n.expired>(new Date).getTime())&&(t=!1),t},util$5.getAll=function(e){let t={};if(e)for(let n in dataCache)0==n.indexOf(e)&&(t[e]=dataCache[e]);else t=dataCache;for(let e in t)util$5.isExpired(e)&&(delete t[e],delete dataCache[e]);return t};var temporaryCache=util$5,globalDataCache={},util$6={},globalDataDao={};globalDataCache.init=function(e){globalDataDao=(util$6=e).vk.system.globalDataDao},globalDataCache.get=async function(e,t=0,n,a=!0){return"function"==typeof n?globalDataCache.autoGet(e,t,n,a):globalDataCache._get(e)},globalDataCache.autoGet=async function(e,t=0,n,a=!0){let i,{vk:r}=util$6;try{i=await globalDataCache._get(e),r.pubfn.isNull(i)&&"function"==typeof n&&(i=await n(),void 0!==i&&a&&await r.globalDataCache.set(e,i,t))}catch(e){return}return i},globalDataCache._get=async function(e){let t;try{let n=await globalDataDao.find(e);if(n){let{value:a,expired_at:i}=n;globalDataCache.isExpired(n)?await globalDataCache.del(e):t=a}}catch(e){return}return t},globalDataCache.set=async function(e,t,n=0,a){let i;e&&void 0!==e.key&&void 0!==e.value?(i=e.key,t=e.value,n=e.second,a=e.comment):i=e;let r={code:0,msg:"ok"};try{if(!i)return{code:-1,msg:"key值不能为空"};let e=n>0?Date.now()+1e3*n:0;r=await globalDataDao.set({key:i,value:t,expired_at:e,comment:a})}catch(e){return console.error(e),{code:-1,msg:"异常"}}return r},globalDataCache.del=async function(e){return await globalDataDao.del(e)},globalDataCache.clear=async function(e){if(e)return await globalDataDao.deleteByWhere({key:new RegExp("^"+e)})},globalDataCache.list=async function(e){return await globalDataDao.list(e)},globalDataCache.count=async function(e){return await globalDataDao.count(e)},globalDataCache.isExpired=function(e){let t=!0;return e&&(!e.expired_at||0==e.expired_at||e.expired_at>Date.now())&&(t=!1),t},globalDataCache.inc=async function(e,t=1,n=0){let a;e&&void 0!==e.key&&void 0!==e.value?(a=e.key,t=e.value,n=e.second):a=e;let i={code:0,msg:"ok"};try{if(!a)return{code:-1,msg:"key值不能为空"};let e=n>0?Date.now()+1e3*n:0;i=await globalDataDao.inc({key:a,value:t,expired_at:e})}catch(e){return{code:-1,msg:"异常",err:e}}return i},globalDataCache.uniqueAdd=async function(e,t=1,n=5){let{vk:a}=util$6,i={code:0,msg:"ok"};try{if(!e)return{code:-1,msg:"key值不能为空"};let r=n>0?Date.now()+1e3*n:0;await a.globalDataCache.deleteExpired(e);i.id=await globalDataDao.add({key:e,value:t,expired_at:r})}catch(e){return{code:-1,msg:"already exists"}}return i},globalDataCache.deleteExpired=async function(e){return await globalDataDao.deleteExpired(e)},globalDataCache.updateById=async function(e,t){return await globalDataDao.updateById(e,t)},globalDataCache.find=async function(e){return await globalDataDao.find(e)},globalDataCache.delByValue=async function(e,t){return await globalDataDao.delByValue(e,t)};var globalDataCache_1=globalDataCache,util$7={aes:{}};const aesKey="5fb2cd73c7b53918728417c50762e6d45fb2cd73c7b53918728417c50762e6d4",AESMODE={AES192:"aes192",AES256ECB:"aes-256-ecb"};util$7.aes.MODE=AESMODE,util$7.aes.encrypt=function(e){let{data:t,key:n,mode:a=AESMODE.AES192}=e,i=uniCloud.vk,{crypto:r,config:o}=i.getUnicloud();if(n||(n=i.pubfn.getData(o.vk,"crypto.aes",aesKey)),"object"==typeof t&&(t=JSON.stringify(t)),a===AESMODE.AES256ECB)return encryptUseAes256Ecb(t,n);if(a===AESMODE.AES192)return encryptUseAes192(t,n);throw new Error(`msg:不支持 ${a} 加密算法`)},util$7.aes.decrypt=function(e){let{data:t,key:n,mode:a=AESMODE.AES192}=e,i=uniCloud.vk,{crypto:r,config:o}=i.getUnicloud();if(i.pubfn.isNull(t))throw new Error("msg:待解密原文不能为空");if(n||(n=i.pubfn.getData(o.vk,"crypto.aes",aesKey)),a===AESMODE.AES256ECB)return decryptUseAes256Ecb(t,n);if(a===AESMODE.AES192)return decryptUseAes192(t,n);throw new Error(`msg:不支持 ${a} 加密算法`)};var crypto=util$7;function encryptUseAes192(e,t){let n=uniCloud.vk,{crypto:a}=n.getUnicloud();const i=a.createCipher(AESMODE.AES192,t);let r=i.update(e,"utf8","hex");return r+=i.final("hex"),r}function decryptUseAes192(e,t){let n,a=uniCloud.vk,{crypto:i}=a.getUnicloud();try{const a=i.createDecipher(AESMODE.AES192,t);n=a.update(e,"hex","utf8"),n+=a.final("utf8");try{n=JSON.parse(n)}catch(e){}}catch(e){throw"msg:解密失败"}return n}function encryptUseAes256Ecb(e,t){let n=uniCloud.vk,{crypto:a}=n.getUnicloud(),i=Buffer.from(e),r=t;r.length>32&&(r=r.substring(0,32)),r=Buffer.from(r);const o=a.createCipheriv(AESMODE.AES256ECB,r,"");o.setAutoPadding(!1);const s=16-i.length%16,u=Buffer.alloc(s,s);i=Buffer.concat([i,u]);let l=o.update(i,null,"base64");return l+=o.final("base64"),l}function decryptUseAes256Ecb(e,t){let n=uniCloud.vk,{crypto:a}=n.getUnicloud(),i=t;i.length>32&&(i=i.substring(0,32)),i=Buffer.from(i);try{const t=a.createDecipheriv(AESMODE.AES256ECB,i,"");t.setAutoPadding(!1);let n=t.update(e,"base64");n+=t.final();const r=n.charCodeAt(n.length-1);n=n.slice(0,n.length-r);try{n=JSON.parse(n)}catch(e){}return n}catch(e){throw"解密失败"}}var alipay={},ALIPAY_ALGORITHM_MAPPING={RSA:"RSA-SHA1",RSA2:"RSA-SHA256"};alipay.sign=function(e,t,n){let a=JSON.parse(JSON.stringify(t)),i=Object.assign({method:e,app_id:n.appid,charset:n.charset||"utf-8",version:n.version||"1.0",sign_type:n.signType||"RSA2"},a);n.appCertSn&&n.alipayRootCertSn&&(i=Object.assign({app_cert_sn:n.appCertSn,alipay_root_cert_sn:n.alipayRootCertSn},i));const r=a.bizContent||a.biz_content;r&&(i.biz_content=JSON.stringify(r));const o=alipay.sortObj(i);let s=alipay.objectToUrl(o);const u="PKCS8"===(n.keyType||"PKCS8")?"PRIVATE KEY":"RSA PRIVATE KEY";let l=alipay.formatKey(n.privateKey,u);const c=crypto$1.createSign(ALIPAY_ALGORITHM_MAPPING[i.sign_type]).update(s,"utf8").sign(l,"base64");return Object.assign(o,{sign:c})},alipay.formatUrl=function(e,t="https://openapi.alipay.com/gateway.do"){let n=t;const a=["app_id","method","format","charset","sign_type","sign","timestamp","version","notify_url","return_url","auth_token","app_auth_token","ws_service_url"];for(const t in e)if(a.indexOf(t)>-1){const a=encodeURIComponent(e[t]);n=`${n}${n.includes("?")?"&":"?"}${t}=${a}`,delete e[t]}return{execParams:e,url:n}},alipay.sortObj=function(e){new Array;let t=Object.keys(e).sort(),n={};for(let a in t)n[t[a]]=e[t[a]];return n},alipay.objectToUrl=function(e){let t="";for(let n in e)e[n]&&(t+=`&${n}=${e[n]}`);return t&&(t=t.substring(1)),t},alipay.formatKey=function(e,t){return`-----BEGIN ${t}-----\n${e}\n-----END ${t}-----`},alipay.getRequestRes=function(e,t){return e[t.replace(new RegExp("\\.","g"),"_")+"_response"]||e.error_response};var util$8=alipay,alipay$1={},util$9={};const serviceUrl="https://openapi.alipay.com/gateway.do",configKey="mp-alipay.oauth.alipay";function returnRes(e){return e.code=e.sub_code||e.code||0,e.msg=e.sub_msg||e.msg||"",e}alipay$1.init=function(e){util$9=e},alipay$1.getConfig=function(){let{vk:e,config:t}=util$9;return e.pubfn.getUniIdConfig(t)},alipay$1.request=async function(e={}){let{vk:t}=util$9,{method:n,data:a={},successText:i}=e,r=alipay$1.auth.getAppidInfo(e),o=Date.now(),s={timestamp:t.pubfn.timeFormat(o,"yyyy-MM-dd hh:mm:ss"),...a};const u=util$8.sign(n,s,r),{url:l,execParams:c}=util$8.formatUrl(u,serviceUrl);let d=await t.request({url:l,method:"POST",data:c}),p=await util$8.getRequestRes(d,n);return p.code&&"10000"!==p.code||(p.code=0,p.msg=i),p=returnRes(p),p},alipay$1.auth={},alipay$1.auth.getAppidInfo=function(e={}){let{appid:t,privateKey:n}=e,{vk:a,config:i}=util$9;const r=alipay$1.getConfig();if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.alipay.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};if(t=r.appid,n=r.privateKey,a.pubfn.isNullOne(t,n))throw console.log("config",e),new Error(`你使用了多小程序登录模式，但未找到${t}对应的 privateKey 请先在 uni-config-center/vk-unicloud/index.js 中配置支付宝小程序（vk.oauth.alipay.list）的appid和privateKey`)}}else{let e=a.pubfn.getData(r,configKey)||{};if(t=e.appid,n=e.privateKey,a.pubfn.isNullOne(t,n))throw console.log("config",r),new Error(`请先在 uni-config-center/uni-id/config.json 中配置支付宝小程序（${configKey}）的appid和privateKey`)}return{appid:t,privateKey:n}},alipay$1.auth.code2Session=async function(e={}){let{vk:t}=util$9,{platform:n,needKey:a=!1}=e;n||(n="mp-alipay");let i=await alipay$1.auth.code2SessionMp(e);try{let e=t.crypto.aes.encrypt({data:i});i.encryptedKey=e}catch(e){}return a||(delete i.sessionKey,delete i.accessToken,delete i.refreshToken),delete i.privateKey,i.platform=n,i.openid=i.userId,i},alipay$1.auth.code2SessionMp=async function(e={}){let{appid:t}=alipay$1.auth.getAppidInfo(e),n=e.code||e.js_code,{vk:a}=util$9,i=await alipay$1.request({method:"alipay.system.oauth.token",data:{code:n,grant_type:"authorization_code"}});return{...a.pubfn.snake2camelJson(i),appid:t,code:0,msg:"ok"}},alipay$1.security={},alipay$1.security.msgSecCheck=async function(e={}){return{code:-1,msg:"支付宝未提供此API"}},alipay$1.security.imgSecCheck=async function(e={}){return{code:-1,msg:"支付宝未提供此API"}},alipay$1.acode={},alipay$1.acode.getMiniCode=async function(e={}){let{page:t,scene:n="miniCode=1",line_color:a}=e,i={url_param:t,query_param:n,describe:"推广",color:a};return await alipay$1.request({method:"alipay.open.app.qrcode.create",data:{biz_content:i},successText:"生成成功"})},alipay$1.subscribeMessage={},alipay$1.subscribeMessage.send=async function(e={}){let{touser:t,form_id:n,template_id:a,page:i,data:r}=e,{appid:o}=alipay$1.auth.getAppidInfo(e),s={to_user_id:t,form_id:n,user_template_id:a,page:i,data:r};return await alipay$1.request({method:"alipay.open.app.mini.templatemessage.send",data:{biz_content:s},successText:"发送成功"})};var alipay_1=alipay$1,baidu={},util$a={};baidu.init=function(e){util$a=e},baidu.open={},baidu.open.auth={},baidu.open.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=util$a;if(!t){let e=a.pubfn.getData(i,"vk.service.openapi.baidu")||{};t=e.appid,n=e.appsecret}if(a.pubfn.isNullOne(t,n))throw new Error("请在uniCloud/cloudfunctions/common/uni-config-center/vk-unicloud/index.js中配置并检查百度开放平台的appid和appsecret是否正确，参数路径：vk.service.openapi.baidu");return{appid:t,appsecret:n}},baidu.open.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=baidu.open.auth.getAppidInfo(e),{vk:a,config:i}=util$a,r=await a.request({url:`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${t}&client_secret=${n}`,method:"GET"});return r.error_code?(console.error("getAccessToken失败：",r),{code:r.error_code,msg:r.error_msg,err:r}):{...r,code:0,msg:"ok"}},baidu.open.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=baidu.open.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=util$a,o="openapi-baidu-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await baidu.open.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await r.globalDataCache.set(o,t,n.expires_in-3600),await r.globalDataCache.deleteExpired())}return t},baidu.open.ocr={},baidu.open.ocr.business_license=async function(e={}){let{image:t,url:n}=e;return await baidu.open.request({...e,action:"ocr/v1/business_license",actionVersion:"2.0",data:{image:t,url:n}})},baidu.open.ocr.idcard=async function(e={}){let{image:t,url:n,id_card_side:a,detect_risk:i,detect_photo:r}=e;return await baidu.open.request({...e,action:"ocr/v1/idcard",actionVersion:"2.0",data:{image:t,url:n,id_card_side:a,detect_risk:i,detect_photo:r}})},baidu.open.request=async function(e={}){let{vk:t}=util$a,n=await baidu.open.auth.getAccessToken(e);if(!n)return{code:-1,msg:"获取access_token失败，请检查vk-unicloud配置下vk.service.openapi.baidu配置的appid和appsecret是否正确"};let{action:a,actionVersion:i="2.0",timeout:r,header:o={"content-type":"application/x-www-form-urlencoded"},data:s}=e,u=await t.request({url:`https://aip.baidubce.com/rest/${i}/${a}?access_token=${n}`,method:"POST",timeout:r,headers:{"content-type":"application/x-www-form-urlencoded"},data:s});return u.error_code?{code:u.error_code,msg:u.error_msg,err:u}:{...u,code:0,msg:"ok"}};var baidu_1=baidu,douyin={},util$b={};const serviceUrl$1="https://developer.toutiao.com",configKey$1="mp-toutiao.oauth.toutiao";function returnRes$1(e){return e.code=e.err_no||0,e.msg=e.err_tips||"",e}douyin.init=function(e){util$b=e},douyin.getConfig=function(){let{vk:e,config:t}=util$b;return e.pubfn.getUniIdConfig(t)},douyin.request=async function(e={}){let{vk:t}=util$b,{url:n,data:a={}}=e,{appid:i,appsecret:r}=douyin.auth.getAppidInfo(e);if(!0===a.access_token){let t=await douyin.auth.getAccessToken(e);if(!t)return{code:-1,msg:`获取access_token失败，请检查uni-id配置${configKey$1}配置下的appid和appsecret是否正确`};a.access_token=t}-1===n.indexOf("http")&&(n=`${serviceUrl$1}/${n}`);let o=await t.request({contentType:"json",dataType:"json",...e,url:n});return o=returnRes$1(o),o},douyin.auth={},douyin.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=util$b;const r=douyin.getConfig();if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.toutiao.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};if(t=r.appid,n=r.appsecret,a.pubfn.isNullOne(t,n))throw console.log("config",e),new Error(`你使用了多小程序登录模式，但未找到${t}对应的 appsecret 请先在 uni-config-center/vk-unicloud/index.js 中配置抖音小程序（vk.oauth.toutiao.list）的appid和appsecret`)}}else{let e=a.pubfn.getData(r,configKey$1)||{};if(t=e.appid,n=e.appsecret,a.pubfn.isNullOne(t,n))throw console.log("config",r),new Error(`请先在 uni-config-center/uni-id/config.json 中配置抖音小程序（${configKey$1}）的appid和appsecret`)}return{appid:t,appsecret:n}},douyin.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=douyin.auth.getAppidInfo(e),{vk:a,config:i}=util$b,r=await a.request({url:serviceUrl$1+"/api/apps/v2/token",method:"POST",data:{appid:t,secret:n,grant_type:"client_credential"},contentType:"json",dataType:"json"});return r.err_no?(console.error("getAccessToken失败：",r),{code:r.err_no,msg:r.err_tips,err:r}):{code:0,msg:"ok",access_token:r.data.access_token,expires_in:r.data.expires_in}},douyin.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=douyin.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=util$b,o="mp-toutiao-access_token-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await douyin.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await r.globalDataCache.set(o,t,240),await r.globalDataCache.deleteExpired())}return t},douyin.auth.code2Session=async function(e={}){let{vk:t}=util$b,{platform:n,needKey:a=!1}=e;n||(n="mp-toutiao");let i=await douyin.auth.code2SessionMp(e);try{let e=t.crypto.aes.encrypt({data:i});i.encryptedKey=e}catch(e){}return a||(delete i.sessionKey,delete i.accessToken,delete i.refreshToken),delete i.appsecret,i.platform=n,i},douyin.auth.code2SessionMp=async function(e={}){let{appid:t,appsecret:n}=douyin.auth.getAppidInfo(e),a=e.code||e.js_code,i=e.anonymousCode,{vk:r}=util$b,o=await douyin.request({url:"api/apps/v2/jscode2session",method:"POST",data:{appid:t,secret:n,code:a,anonymous_code:i}});return o.code?(40018!==o.code&&40019!==o.code||(o.msg="无效code，请重新获取"),o):{...r.pubfn.snake2camelJson(o.data),appid:t,appsecret:n,code:0,msg:"ok"}},douyin.security={},douyin.security.msgSecCheck=async function(e={}){let{content:t,tasks:n}=e,{appid:a,appsecret:i}=douyin.auth.getAppidInfo(e),r=await douyin.auth.getAccessToken(e);if(!r)return{code:-1,msg:`获取access_token失败，请检查uni-id配置${configKey$1}配置下的appid和appsecret是否正确`};n||(n=[{content:t}]);let o=await douyin.request({url:"api/v2/tags/text/antidirt",method:"POST",header:{"X-Token":r},data:{tasks:n}});try{let e,t;o.data.map((n,a)=>{n.predicts.map((n,i)=>{n.hit&&(e||(e=!0,t=a))})}),e?(o.taskIndex=t,o.code=87014):o.code=0}catch(e){}return 40001===o.code&&(o.msg="access_token错误"),87014===o.code&&(o.msg="内容含有违法违规内容，请检查!"),0===o.code&&(o.msg="ok"),o},douyin.security.imgSecCheck=async function(e={}){let{image:t,access_token:n=!0}=e,a=e.base64||e.image_data,{appid:i,appsecret:r}=douyin.auth.getAppidInfo(e);if(a){let e=a.indexOf("base64,");e>-1&&(a=a.substring(e+"base64,".length))}let o=await douyin.request({url:"api/apps/censor/image",method:"POST",data:{app_id:i,access_token:n,image:t,image_data:a}});try{let e;o.predicts.map((t,n)=>{t.hit&&(e=!0)}),o.code=e?87014:0}catch(e){}return 87014===o.code&&(o.msg="内容含有违法违规内容，请检查!"),0===o.code&&(o.msg="ok"),o},douyin.acode={},douyin.acode.getMiniCode=async function(e={}){let{path:t,appname:n="douyin",width:a,line_color:i,background:r,set_icon:o,access_token:s=!0}=e,{appid:u,appsecret:l}=douyin.auth.getAppidInfo(e),c=await douyin.request({url:"api/apps/qrcode",method:"POST",data:{access_token:s,appname:n,path:t,width:a,line_color:i,background:r,set_icon:o},dataType:"default",useContent:!0,header:{"content-type":"application/json;charset=utf8"}});if(c.length<500){let e=c.toString();try{return e=JSON.parse(e),{code:e.errcode,msg:e.errmsg}}catch(e){}return{code:-1,err:err}}return c},douyin.subscribeMessage={},douyin.subscribeMessage.send=async function(e={}){let{touser:t,template_id:n,page:a,data:i,access_token:r=!0}=e,{appid:o,appsecret:s}=douyin.auth.getAppidInfo(e);return await douyin.request({url:"api/apps/subscribe_notification/developer/v1/notify",method:"POST",data:{access_token:r,app_id:o,tpl_id:n,open_id:t,data:i,page:a}})};var douyin_1=douyin,qq={},util$c={};const serviceUrl$2="https://api.q.qq.com",configKey$2="mp-qq.oauth.qq";function returnRes$2(e){return e.code=e.errcode||e.errCode||0,e.msg=e.errmsg||e.errMsg||"",e}qq.init=function(e){util$c=e},qq.getConfig=function(){let{vk:e,config:t}=util$c;return e.pubfn.getUniIdConfig(t)},qq.request=async function(e={}){let{vk:t}=util$c,{url:n,method:a,data:i={}}=e;if(-1===n.indexOf("http")&&(n=`${serviceUrl$2}/${n}`),!0===i.access_token){delete i.access_token;let t=await qq.auth.getAccessToken(e);if(!t)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-qq配置的appid和appsecret是否正确"};n+=-1===n.indexOf("?")?"?":"&",n+="access_token="+t}let r=await t.request({...e,url:n});return r=returnRes$2(r),r},qq.auth={},qq.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=util$c;const r=qq.getConfig();if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.qq.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};if(t=r.appid,n=r.appsecret,a.pubfn.isNullOne(t,n))throw console.log("config",e),new Error(`你使用了多小程序登录模式，但未找到${t}对应的 appsecret 请先在 uni-config-center/vk-unicloud/index.js 中配置QQ小程序（vk.oauth.qq.list）的appid和appsecret`)}}else{let e=a.pubfn.getData(r,configKey$2)||{};if(t=e.appid,n=e.appsecret,a.pubfn.isNullOne(t,n))throw console.log("config",r),new Error("请先在 uni-config-center/uni-id/config.json 中配置QQ小程序（mp-qq.oauth.qq）的appid和appsecret")}return{appid:t,appsecret:n}},qq.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=qq.auth.getAppidInfo(e),{vk:a,config:i}=util$c,r=await a.request({url:`https://api.q.qq.com/api/getToken?grant_type=client_credential&appid=${t}&secret=${n}`,method:"GET"});return r.errcode?(console.error("getAccessToken失败：",r),{code:r.errcode,msg:r.errmsg,err:r}):{code:0,msg:"ok",access_token:r.access_token,expires_in:r.expires_in}},qq.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=qq.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=util$c,o="mp-qq-access_token-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await qq.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await r.globalDataCache.set(o,t,240),await r.globalDataCache.deleteExpired())}return t},qq.auth.code2Session=async function(e={}){let{vk:t}=util$c,{platform:n,needKey:a=!1}=e;n||(n="mp-qq");let i=await qq.auth.code2SessionMpWeixin(e);try{let e=t.crypto.aes.encrypt({data:i});i.encryptedKey=e}catch(e){}return a||(delete i.sessionKey,delete i.accessToken,delete i.refreshToken),delete i.appsecret,i.platform=n,i},qq.auth.code2SessionMpWeixin=async function(e={}){let{appid:t,appsecret:n}=qq.auth.getAppidInfo(e),a=e.code||e.js_code,{vk:i}=util$c,r=await qq.request({url:`sns/jscode2session?appid=${t}&secret=${n}&js_code=${a}&grant_type=authorization_code`,method:"GET"});return r.code?(-101600007===r.code&&(r.msg="appid错误"),-101222100===r.code&&(r.msg="appsecret错误"),-2100===r.code&&(r.msg="无效code，请重新获取"),r):(r=i.pubfn.snake2camelJson(r),{appid:t,appsecret:n,...r,code:0,msg:"ok"})},qq.security={},qq.security.msgSecCheck=async function(e={}){let{content:t,access_token:n=!0}=e,{appid:a,appsecret:i}=qq.auth.getAppidInfo(e),r=await qq.request({url:"api/json/security/MsgSecCheck",method:"POST",data:{access_token:n,appid:a,content:t}});return 40001===r.code&&(r.msg="access_token错误"),87014===r.code&&(r.msg="内容含有违法违规内容，请检查!"),r},qq.security.imgSecCheck=async function(e={}){let{vk:t}=util$c,{dataBuffer:n,formData:a,base64:i}=e,{appid:r,appsecret:o}=qq.auth.getAppidInfo(e),s=await qq.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-qq配置的appid和appsecret是否正确"};if(i&&!n){let e="base64,",t=i.indexOf(e);t>-1&&(i=i.substring(t+e.length)),n=new Buffer(i,"base64")}n&&!a&&(a=new t.formDataUtil.FormData,a.append("appid",r),a.append("media",n,{filename:Date.now()+".png",contentType:"image/png"}));let u=await qq.request({url:"api/json/security/ImgSecCheck?access_token="+s,content:a.getBuffer(),headers:a.getHeaders()});switch(u.code){case 40001:u.msg="access_token错误";break;case 87014:u.msg="图片内容含有违法违规内容，请检查!";break;case 40006:u.msg="图片大小不能超过1M"}return u},qq.acode={},qq.acode.getMiniCode=async function(e={}){let{path:t,access_token:n=!0}=e,{appid:a,appsecret:i}=qq.auth.getAppidInfo(e),r=await qq.request({url:"api/json/qqa/CreateMiniCode",method:"POST",data:{access_token:n,appid:a,path:t},dataType:"default",useContent:!0,header:{"content-type":"application/json;charset=utf8"}});if(r.length<500){let e=r.toString();try{e=JSON.parse(e)}catch(e){}return r=returnRes$2(e),40001===r.code&&(r.msg="access_token错误"),41030===r.code&&(r.msg="小程序页面不存在!"),r}return r},qq.subscribeMessage={},qq.subscribeMessage.send=async function(e={}){let{vk:t}=util$c,{touser:n,template_id:a,page:i,data:r,emphasis_keyword:o,oac_appid:s,use_robot:u}=e,l=await qq.auth.getAccessToken(e);if(!l)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-qq配置的appid和appsecret是否正确"};let c=await t.request({url:`${serviceUrl$2}/api/json/subscribe/SendSubscriptionMessage?access_token=${l}`,method:"POST",data:{touser:n,template_id:a,page:i,data:r,emphasis_keyword:o,oac_appid:s,use_robot:u},useContent:!0,header:{"content-type":"application/json;charset=utf8"}});switch(c=returnRes$2(c),c.code){case 40003:c.msg="touser字段openid为空或者不正确";break;case 40037:c.msg="订阅模板id为空不正确";break;case 43101:c.msg="用户未订阅该消息";break;case 40036:c.msg="您的小程序不支持发送长期订阅消息";break;case 47003:c.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:c.msg="page路径不正确，需要保证在现网版本小程序中存在"}return c};var qq_1=qq,weixin={},util$d={};function returnRes$3(e){return e.code=e.errcode||0,e.msg=e.errmsg||"",e}weixin.init=function(e){util$d=e},weixin.getConfig=function(){let{vk:e,config:t}=util$d;return e.pubfn.getUniIdConfig(t)},weixin.request=async function(e={}){let{vk:t}=util$d,{url:n,method:a,data:i,access_token:r}=e;if(r||(r=await weixin.auth.getAccessToken(e)),!r)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};-1===n.indexOf("http")&&(n="https://api.weixin.qq.com/"+n),a||(a=t.pubfn.isNull(i)?"GET":"POST"),a&&"POST"===a.toUpperCase()&&void 0===e.useContent&&(e.useContent=!0),n+=-1===n.indexOf("?")?"?":"&",n+="access_token="+r;let o=await t.request({...e,url:n});return o=returnRes$3(o),o},weixin.decrypt={},weixin.decrypt.getPhoneNumber=async function(e={}){let{vk:t}=util$d,{code:n}=e;if(!n&&e.encryptedData)return await weixin.decrypt.getPhoneNumberByEncryptedData(e);let a={code:0,msg:"ok"},i=t.pubfn.isNullOneByObject({code:n});if(i)return{code:-1,msg:i+"不能为空"};let r=await t.openapi.weixin.request({method:"POST",url:"wxa/business/getuserphonenumber",data:{code:n}});return 0!==r.code?r:(a.data=r.phone_info,a.phone=a.data.phoneNumber,a.mobile=a.data.phoneNumber,a)},weixin.decrypt.getPhoneNumberByEncryptedData=async function(e={}){let t,{vk:n}=util$d,{encryptedData:a,iv:i,sessionKey:r,encryptedKey:o,code:s}=e,u={code:0,msg:"ok"},l=n.pubfn.isNullOneByObject({encryptedData:a,iv:i});if(l)return{code:-1,msg:l+"不能为空"};if(o){let e=n.crypto.aes.decrypt({data:o});t=e.appid,r=e.sessionKey}else{t=weixin.auth.getAppidInfo(e).appid}return u.data=weixin.decrypt.decryptData({appid:t,encryptedData:a,iv:i,sessionKey:r}),u.phone=u.data.phoneNumber,u.mobile=u.data.phoneNumber,u},weixin.decrypt.decryptData=function(e={}){let t,{appid:n,encryptedData:a,iv:i,sessionKey:r}=e,{vk:o,crypto:s}=util$d,u=new Buffer(r,"base64"),l=new Buffer(a,"base64"),c=new Buffer(i,"base64");try{let e=s.createDecipheriv("aes-128-cbc",u,c);e.setAutoPadding(!0),t=e.update(l,"binary","utf8"),t+=e.final("utf8"),t=JSON.parse(t)}catch(e){throw new Error(e)}return t.watermark.appid!==n?{code:-1,msg:"appid不一致"}:t},weixin.auth={},weixin.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=util$d;const r=weixin.getConfig();if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.weixin.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};if(t=r.appid,n=r.appsecret,a.pubfn.isNullOne(t,n))throw console.log("config",e),new Error(`你使用了多小程序登录模式，但未找到${t}对应的 appsecret 请先在 uni-config-center/vk-unicloud/index.js 中配置微信小程序（vk.oauth.weixin.list）的appid和appsecret`)}}else{let e=a.pubfn.getData(r,"mp-weixin.oauth.weixin")||{};if(t=e.appid,n=e.appsecret,a.pubfn.isNullOne(t,n))throw console.log("config",r),new Error("请先在 uni-config-center/uni-id/config.json 中配置微信小程序（mp-weixin）的appid和appsecret")}return{appid:t,appsecret:n}},weixin.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=weixin.auth.getAppidInfo(e),{vk:a,config:i}=util$d,r=await a.request({url:`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${t}&secret=${n}`,method:"GET"});return r.errcode?(console.error("getAccessToken失败：",r),{code:r.errcode,msg:r.errmsg,err:r}):{code:0,msg:"ok",access_token:r.access_token,expires_in:r.expires_in}},weixin.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=weixin.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=util$d,o="mp-weixin-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await weixin.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await r.globalDataCache.set(o,t,240),await r.globalDataCache.deleteExpired())}return t},weixin.auth.code2Session=async function(e={}){let t,{vk:n,uniID:a}=util$d,{platform:i,context:r,needKey:o=!1}=e;i||(i=n.pubfn.getPlatformForUniId(r)||"mp-weixin"),t="mp-weixin"===i?await weixin.auth.code2SessionMpWeixin(e):"h5-weixin"===i?await weixin.h5.auth.code2Session(e):await a.code2SessionWeixin(e);try{let e=n.crypto.aes.encrypt({data:t});t.encryptedKey=e}catch(e){}return o||(delete t.sessionKey,delete t.accessToken,delete t.refreshToken),delete t.appsecret,t.platform=i,t},weixin.auth.code2SessionMpWeixin=async function(e={}){let{appid:t,appsecret:n}=weixin.auth.getAppidInfo(e),a=e.code||e.js_code,{vk:i}=util$d,r=await i.request({url:`https://api.weixin.qq.com/sns/jscode2session?appid=${t}&secret=${n}&js_code=${a}&grant_type=authorization_code`,method:"GET"});if(r.errcode){let e=r.errmsg;return 40163===r.errcode&&(e="该code已被使用，请重新获取"),40029===r.errcode&&(e="无效code，请重新获取"),{...r,code:r.errcode,msg:e}}return r=i.pubfn.snake2camelJson(r),{appid:t,appsecret:n,...r,code:0,msg:"ok"}},weixin.wxacode={},weixin.wxacode.getUnlimited=async function(e={}){let{vk:t}=util$d,{access_token:n,page:a,scene:i,check_path:r,env_version:o,width:s,auto_color:u,line_color:l,is_hyaline:c}=e;if(n||(n=await weixin.auth.getAccessToken(e)),!n)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};let d=await t.request({url:"https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token="+n,method:"POST",data:{page:a,scene:i,check_path:r,env_version:o,width:s,auto_color:u,line_color:l,is_hyaline:c},dataType:"default",useContent:!0,headers:{encoding:null}});if(d.length<500){let e=d.toString();try{e=JSON.parse(e)}catch(e){}return d=returnRes$3(e),40001===d.code&&(d.msg="access_token错误"),41030===d.code&&(d.msg="小程序页面不存在!"),d}return Buffer.isBuffer(d)?d:returnRes$3(d)},weixin.urlscheme={},weixin.urlscheme.generate=async function(e={}){let{vk:t}=util$d,{access_token:n,jump_wxa:a,is_expire:i,expire_time:r,expire_type:o,expire_interval:s}=e;if(n||(n=await weixin.auth.getAccessToken(e)),!n)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};let u=await t.request({url:"https://api.weixin.qq.com/wxa/generatescheme?access_token="+n,method:"POST",data:{jump_wxa:a,is_expire:i,expire_time:r,expire_type:o,expire_interval:s},useContent:!0});return u=returnRes$3(u),40001===u.code&&(u.msg="access_token错误"),40165===u.code&&(u.msg="小程序页面不存在!"),u},weixin.urllink={},weixin.urllink.generate=async function(e={}){let{vk:t}=util$d,{access_token:n,path:a,query:i,is_expire:r,expire_type:o,expire_time:s,expire_interval:u,cloud_base:l,env_version:c}=e;if(n||(n=await weixin.auth.getAccessToken(e)),!n)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};let d=await t.request({url:"https://api.weixin.qq.com/wxa/generate_urllink?access_token="+n,method:"POST",data:{path:a,query:i,is_expire:r,expire_type:o,expire_time:s,expire_interval:u,cloud_base:l,env_version:c},useContent:!0});return d=returnRes$3(d),40001===d.code&&(d.msg="access_token错误"),40165===d.code&&(d.msg="小程序页面不存在!"),d},weixin.security={},weixin.security.msgSecCheck=async function(e={}){let{vk:t}=util$d,{content:n,version:a,scene:i,openid:r,title:o,nickname:s,signature:u}=e,l=await weixin.auth.getAccessToken(e);if(!l)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};let c=await t.request({url:"https://api.weixin.qq.com/wxa/msg_sec_check?access_token="+l,method:"POST",data:{content:n,version:a,scene:i,openid:r,title:o,nickname:s,signature:u},useContent:!0});return c=returnRes$3(c),40001===c.code&&(c.msg="access_token错误"),87014===c.code&&(c.msg="内容含有违法违规内容，请检查!"),2===a&&c.result&&100!==c.result.label&&(c.code=c.result.label,c.msg="内容含有违法违规内容，请检查!"),c},weixin.security.imgSecCheck=async function(e={}){let{vk:t}=util$d,{dataBuffer:n,formData:a,base64:i}=e,r=await weixin.auth.getAccessToken(e);if(!r)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};if(i&&!n){let e="base64,",t=i.indexOf(e);t>-1&&(i=i.substring(t+e.length)),n=new Buffer(i,"base64")}n&&!a&&(a=new t.formDataUtil.FormData,a.append("media",n,{filename:Date.now()+".png",contentType:"image/png"}));let o=await t.request({url:"https://api.weixin.qq.com/wxa/img_sec_check?access_token="+r,content:a.getBuffer(),headers:a.getHeaders()});switch(o=returnRes$3(o),o.code){case 40001:o.msg="access_token错误";break;case 87014:o.msg="图片内容含有违法违规内容，请检查!";break;case 40006:o.msg="图片大小不能超过1M"}return o},weixin.riskControl={},weixin.riskControl.getUserRiskRank=async function(e={}){let{vk:t}=util$d,{appid:n,openid:a,scene:i,mobile_no:r,client_ip:o,email_address:s,extended_info:u,is_test:l}=e,c=await weixin.auth.getAccessToken(e);if(!c)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};let d=await t.request({url:"https://api.weixin.qq.com/wxa/getuserriskrank?access_token="+c,method:"POST",data:{appid:n,openid:a,scene:i,mobile_no:r,client_ip:o,email_address:s,extended_info:u,is_test:l},useContent:!0});return d=returnRes$3(d),40001===d.code&&(d.msg="access_token错误"),d},weixin.subscribeMessage={},weixin.subscribeMessage.send=async function(e={}){let{vk:t}=util$d,{touser:n,template_id:a,page:i,data:r,miniprogram_state:o="formal",lang:s="zh_CN"}=e,u=await weixin.auth.getAccessToken(e);if(!u)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};let l=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="+u,method:"POST",data:{touser:n,template_id:a,page:i,data:r,miniprogram_state:o,lang:s},useContent:!0});switch(l=returnRes$3(l),l.code){case 40003:l.msg="touser字段openid为空或者不正确";break;case 40037:l.msg="订阅模板id为空不正确";break;case 43101:l.msg="用户未订阅该消息";break;case 47003:l.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:l.msg="page路径不正确，需要保证在现网版本小程序中存在"}return l},weixin.uniformMessage={},weixin.uniformMessage.send=async function(e={}){let{vk:t}=util$d,{appid:n,touser:a,template_appid:i,template_id:r,url:o,miniprogram:s,data:u}=e,l=await weixin.auth.getAccessToken(e);if(!l)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};if(!i){i=weixin.h5.auth.getAppidInfo({appid:i}).appid}let c=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/wxopen/template/uniform_send?access_token="+l,method:"POST",data:{touser:a,mp_template_msg:{appid:i,template_id:r,url:o,miniprogram:s,data:u}},useContent:!0});switch(c=returnRes$3(c),c.code){case 40003:c.msg="touser字段openid为空或者不正确";break;case 40037:c.msg="订阅模板id为空不正确";break;case 43101:c.msg="用户未订阅该消息";break;case 47003:c.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:c.msg="page路径不正确，需要保证在现网版本小程序中存在"}return c},weixin.livebroadcast={},weixin.livebroadcast.getLiveInfo=async function(e={}){let{vk:t}=util$d,{pageIndex:n=1,pageSize:a=100}=e,i=await weixin.auth.getAccessToken(e);if(!i)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的mp-weixin配置的appid和appsecret是否正确"};if(n<=0)return{code:-1,msg:"pageIndex必须是大于0的整数"};let r=(n-1)*a,o=a,s=await t.request({url:"https://api.weixin.qq.com/wxa/business/getliveinfo?access_token="+i,method:"POST",data:{start:r,limit:o},useContent:!0});switch(s=returnRes$3(s),s.code){case 941e4:s.msg="直播间列表为空"}return s},weixin.app={},weixin.app.auth={},weixin.app.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=util$d;const r=weixin.getConfig();if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.weixin.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};t=r.appid,n=r.appsecret}}else{let e=a.pubfn.getData(r,"app-plus.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(a.pubfn.isNullOne(t,n))throw console.log("config",r),new Error("请先在 uni-config-center/uni-id/config.json 中配置微信app登录（app-plus）的appid和appsecret");return{appid:t,appsecret:n}},weixin.app.auth.getAccessToken=async function(e={}){let{appid:t,appsecret:n}=weixin.app.auth.getAppidInfo(e),{vk:a,config:i}=util$d,{code:r}=e,o=await a.request({url:`https://api.weixin.qq.com/sns/oauth2/access_token?appid=${t}&secret=${n}&code=${r}&grant_type=authorization_code`,method:"GET"});return o.errcode?(console.error("getAccessToken失败：",o),{code:o.errcode,msg:o.errmsg,err:o}):{...o,code:0,msg:"ok"}},weixin.app.auth.getUserInfo=async function(e={}){let{vk:t,config:n}=util$d,{access_token:a,openid:i,lang:r="zh-CN"}=e;if(!a)return{code:-1,msg:"access_token不能为空"};let o=await t.request({url:`https://api.weixin.qq.com/sns/userinfo?access_token=${a}&openid=${i}$lang=${r}`,method:"GET"});return o.errcode?(console.error("getUserInfo失败：",o),{code:o.errcode,msg:o.errmsg,err:o}):{...o,code:0,msg:"ok",avatar:o.headimgurl,gender:o.sex}},weixin.h5={},weixin.h5.request=async function(e={}){let{vk:t}=util$d,{url:n,method:a,data:i,access_token:r}=e;if(r||(r=await weixin.h5.auth.getAccessToken(e)),!r)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的h5-weixin配置的appid和appsecret是否正确"};-1===n.indexOf("http")&&(n="https://api.weixin.qq.com/"+n),a||(a=t.pubfn.isNull(i)?"GET":"POST"),a&&"POST"===a.toUpperCase()&&void 0===e.useContent&&(e.useContent=!0),n+=-1===n.indexOf("?")?"?":"&",n+="access_token="+r;let o=await t.request({...e,url:n});return o=returnRes$3(o),o},weixin.h5.auth={},weixin.h5.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=util$d;const r=weixin.getConfig();if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.weixin.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};t=r.appid,n=r.appsecret}}else{let e=a.pubfn.getData(r,"h5-weixin.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(a.pubfn.isNullOne(t,n))throw console.log("config",r),new Error("请先配置微信公众号appid和appsecret");return{appid:t,appsecret:n}},weixin.h5.auth.code2Session=async function(e={}){let{appid:t,appsecret:n}=weixin.h5.auth.getAppidInfo(e),{code:a}=e,{vk:i}=util$d,r=await i.request({url:`https://api.weixin.qq.com/sns/oauth2/access_token?appid=${t}&secret=${n}&code=${a}&grant_type=authorization_code`,method:"GET"});if(r.errcode){let e=r.errmsg;return 40163===r.errcode&&(e="该code已被使用，请重新获取"),40029===r.errcode&&(e="无效code，请重新获取"),{...r,code:r.errcode,msg:e}}return r=i.pubfn.snake2camelJson(r),{appid:t,appsecret:n,...r,code:0,msg:"ok"}},weixin.h5.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=weixin.h5.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=util$d,o="h5-weixin-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await weixin.h5.auth.getAccessTokenFn(e);if(0===n.code)t=n.access_token,await r.globalDataCache.set(o,t,240),await r.globalDataCache.deleteExpired();else if(console.log("获取微信公众号access_token失败:",n),40164===n.code)throw{code:n.code,msg:"请将固定IP全部加入微信公众号IP白名单，详见搜索文档：固定ip",err:n}}return t},weixin.h5.auth.getAccessTokenFn=async function(e={}){let t,{appid:n,appsecret:a}=weixin.h5.auth.getAppidInfo(e),{vk:i,config:r}=util$d;if("aliyun"===i.pubfn.getUniCloudProvider()){let e=await uniCloud.httpProxyForEip.get("https://api.weixin.qq.com/cgi-bin/token",{grant_type:"client_credential",appid:n,secret:a});if("string"==typeof e)try{e=JSON.parse(e)}catch(e){t={errcode:-1,errmsg:"异常"+e.message}}t="object"==typeof e?e.body:{errcode:-1,errmsg:"异常:getRes未获取到值"}}else t=await i.request({url:`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${n}&secret=${a}`,method:"GET"});return t.errcode?(console.error("getAccessToken失败：",t),{code:t.errcode,msg:t.errmsg,err:t}):{code:0,msg:"ok",access_token:t.access_token,expires_in:t.expires_in}},weixin.h5.auth.getJsapiTicket=async function(e={}){let t,{appid:n,appsecret:a}=weixin.h5.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=util$d,o=`h5-weixin:${n}:jsapi_ticket`;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await weixin.h5.auth.getJsapiTicketFn(e);0===n.code?(t=n.jsapi_ticket,await r.globalDataCache.set(o,t,240),await r.globalDataCache.deleteExpired()):console.log("获取微信公众号jsapi_ticket失败:",n)}return{code:0,msg:"ok",appid:n,jsapi_ticket:t}},weixin.h5.auth.getJsapiTicketFn=async function(e={}){let{appid:t,appsecret:n}=weixin.h5.auth.getAppidInfo(e),{vk:a,config:i}=util$d,r=await weixin.h5.auth.getAccessToken(e);if(!r)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的h5-weixin配置的appid和appsecret是否正确"};let o=await a.request({url:`https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${r}&type=jsapi`,method:"GET"});return o.errcode?(console.error("getJsapiTicketFn失败：",o),{code:o.errcode,msg:o.errmsg,err:o}):{code:0,msg:"ok",appid:t,jsapi_ticket:o.ticket,expires_in:o.expires_in}},weixin.h5.auth.getJsapiSign=async function(e={}){let{vk:t,crypto:n}=util$d,{appid:a,appsecret:i}=weixin.h5.auth.getAppidInfo(e),{jsapi_ticket:r}=await t.openapi.weixin.h5.auth.getJsapiTicket(e),{url:o}=e,s=t.pubfn.random(6),u=parseInt((new Date).getTime()/1e3)+"";return{code:0,msg:"ok",url:o,appid:a,config:{appId:a,timestamp:u,nonceStr:s,signature:(e=>{let t=n.createHash("sha1");return t.update(e),e=t.digest("hex")})((e=>Object.keys(e).filter(t=>"sign"!==t&&void 0!==e[t]&&""!==e[t]).sort().map(t=>t+"="+e[t]).join("&"))({jsapi_ticket:r,noncestr:s,timestamp:u,url:o}))}}},weixin.h5.subscribeMessage={},weixin.h5.subscribeMessage.send=async function(e={}){let{vk:t}=util$d,{touser:n,template_id:a,page:i,data:r,miniprogram:o}=e,s=await weixin.h5.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的h5-weixin配置的appid和appsecret是否正确"};let u=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/bizsend?access_token="+s,method:"POST",data:{touser:n,template_id:a,page:i,data:r,miniprogram:o},useContent:!0});switch(u=returnRes$3(u),u.code){case 40003:u.msg="touser字段openid为空或者不正确";break;case 40037:u.msg="订阅模板id为空不正确";break;case 43101:u.msg="用户未订阅该消息";break;case 47003:u.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:u.msg="page路径不正确，需要保证在现网版本小程序中存在"}return u},weixin.h5.templateMessage={},weixin.h5.templateMessage.send=async function(e={}){let{vk:t}=util$d,{touser:n,template_id:a,url:i,miniprogram:r,data:o}=e,s=await weixin.h5.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查uni-id配置下的h5-weixin配置的appid和appsecret是否正确"};let u=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token="+s,method:"POST",data:{touser:n,template_id:a,url:i,miniprogram:r,data:o},useContent:!0});switch(u=returnRes$3(u),u.code){case 40003:u.msg="touser字段openid为空或者不正确";break;case 40037:u.msg="订阅模板id为空不正确";break;case 43101:u.msg="用户未订阅该消息";break;case 47003:u.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:u.msg="page路径不正确，需要保证在现网版本小程序中存在"}return u},weixin.loginByWeixin=async function(e={},t,n){let a,i,r;e.context?(a=e.data||{},i=e.context,r=e.custom,e.appid&&(a.appid=e.appid),e.appsecret&&(a.appsecret=e.appsecret)):(a=e,i=t,r=n);let o,s,{vk:u,uniID:l,_:c}=util$d,{code:d,platform:p,type:f,appid:g}=a;if(p||(p=u.pubfn.getPlatformForUniId(i),a.platform=p),g&&["mp-weixin","h5-weixin","app-plus"].indexOf(p)>-1){let e;"mp-weixin"===p?e=weixin.auth.getAppidInfo(a):"h5-weixin"===p?e=weixin.h5.auth.getAppidInfo(a):"app-plus"===p&&(e=weixin.app.auth.getAppidInfo(a));let{appid:t,appsecret:n}=e,r=u.pubfn.copyObject(weixin.getConfig());u.pubfn.setData(r,p+".oauth.weixin",{appid:t,appsecret:n}),a.platform=p,s=l.createInstance({context:i,config:r})}s||(s=l);try{delete a.role,o=await s.loginByWeixin(a);try{if(o.uid&&!o.msg&&(o.msg="register"===o.type?"注册成功":"登录成功"),o.uid&&"register"===o.type){let e={},t={last_login_date:Date.now(),last_login_ip:i.CLIENTIP};if(["h5-weixin","app-plus"].indexOf(p)>-1){let t=await u.openapi.weixin.app.auth.getUserInfo({access_token:o.accessToken,openid:o.openid});e={nickname:t.nickname,avatar:t.headimgurl}}["mp-weixin"].indexOf(p)>-1&&(e={nickname:a.nickname,avatar:a.avatar}),u.pubfn.isNotNull(r)&&(e=u.pubfn.objectAssign(e,r)),u.pubfn.isNotNull(t)&&(e=u.pubfn.objectAssign(e,t)),u.pubfn.isNotNull(e)&&(o.userInfo=await u.baseDao.updateAndReturn({dbName:"uni-id-users",whereJson:{_id:o.uid||"___",nickname:c.exists(!1)},dataJson:e}))}}catch(e){console.error("保存用户头像昵称异常：",e)}if(0===o.code)try{let t=u.crypto.aes.encrypt({data:{code:0,sessionKey:o.sessionKey,openid:o.openid,unionid:o.unionid,uid:o.uid,accessToken:o.accessToken,accessTokenExpired:o.accessTokenExpired,refreshToken:o.refreshToken}});o.encryptedKey=t,e.needKey||(delete o.sessionKey,delete o.accessToken,delete o.refreshToken)}catch(e){}}catch(e){console.error("loginByWeixin异常：",e);let t=e.message||"";throw e.message.indexOf("code been used")>-1&&(t="该code已被使用，请重新获取"),e.message.indexOf("invalid code")>-1&&(t="无效code，请重新获取"),new Error("msg:"+t)}return o};var weixin_1=weixin,openapi={};openapi.alipay=alipay_1,openapi.baidu=baidu_1,openapi.douyin=douyin_1,openapi.qq=qq_1,openapi.weixin=weixin_1,openapi.init=function(e){openapi.alipay.init(e),openapi.baidu.init(e),openapi.douyin.init(e),openapi.qq.init(e),openapi.weixin.init(e)};var openapi_1=openapi,builder=class{constructor(){this._shouldUseCache=!1,this._cachedBuffer=null,this._lineBreak="\r\n",this._boundary="------FormDataBaseBoundary"+Math.random().toString(36).substring(2),this.dataList=[]}_addData(e){if(this._shouldUseCache=!1,0===this.dataList.length)return void this.dataList.push(e);const t=this.dataList[this.dataList.length-1];switch(`${Buffer.isBuffer(t)?"buffer":"other"}_${Buffer.isBuffer(e)?"buffer":"other"}`){case"buffer_buffer":this.dataList.push(this._lineBreak),this.dataList.push(e);break;case"buffer_other":this.dataList.push(this._lineBreak+e);break;case"other_buffer":this.dataList[this.dataList.length-1]=t+"\r\n",this.dataList.push(e);break;case"other_other":this.dataList[this.dataList.length-1]=t+"\r\n"+e}}append(e,t,n){this._addData("--"+this._boundary);let a=`Content-Disposition: form-data; name="${encodeURIComponent(e)}"`;if(Buffer.isBuffer(t)){if(!n.filename||!n.contentType)throw new Error("filename and contentType required");a+=`; filename="${encodeURIComponent(n.filename)}"`,this._addData(a),this._addData("Content-Type: "+n.contentType),this._addData(""),this._addData(t)}else this._addData(a),this._addData(""),this._addData(t)}getHeaders(e){const t={"Content-Type":"multipart/form-data; boundary="+this._boundary};return Object.assign(t,e)}getBuffer(){if(this._shouldUseCache)return this._cachedBuffer;this._shouldUseCache=!0;let e=Buffer.alloc(0);return this.dataList.forEach(t=>{e=Buffer.isBuffer(t)?Buffer.concat([e,t]):Buffer.concat([e,Buffer.from(""+t)])}),e=Buffer.concat([e,Buffer.from(`${this._lineBreak}--${this._boundary}--`)]),this._cachedBuffer=e,e}};const BOUNDARY_REG=/^multipart\/.+?(?:;\s*boundary=(?:(?:"(.+)")|(?:([^\s]+))))$/i,LEADING_REG=/Content-Disposition:\sform-data;\sname="(.+?)"(?:;\sfilename="(.+?)")?/i,TYPE_REG=/Content-Type:\s(.+?)$/i,lineBreak="\r\n";function split(e,t){let n=0,a=0,i=[];for(;-1!==(a=e.indexOf(t,n));)i.push(e.slice(n,a)),n=a+t.length,a=e.indexOf(t,n);return i}function readParam(e){let t=e.indexOf("\r\n")+"\r\n".length,n=t,a=e.lastIndexOf("\r\n"),i=[];for(;-1!==(n=e.indexOf("\r\n",t));)if(i.push(e.slice(t,n)),t=n+"\r\n".length,0===i[i.length-1].length){i.push(e.slice(t,a));break}return i}var parser=e=>{const t=(e.headers["content-type"]||e.headers["Content-Type"]).match(BOUNDARY_REG),n=t[1]||t[2],a=split(Buffer.from(e.body,"base64"),Buffer.from("--"+n)).map(e=>readParam(e).filter(e=>e.length>0)).filter(e=>2===e.length||3===e.length||4===e.length).map(e=>{const t={},n=e[0].toString().match(LEADING_REG);switch(t.name=decodeURIComponent(n[1]),e.length){case 2:t.value=e[1].toString();break;case 3:t.filename=decodeURIComponent(n[2]),t.contentType=e[1].toString().match(TYPE_REG)[1],t.fileContent=e[2];break;case 4:t.filename=decodeURIComponent(n[2]),t.contentType=e[1].toString().match(TYPE_REG)[1],t.fileContent=e[3]}return t}),i={};return a.forEach(e=>{const t=e.name;delete e.name,i[t]=e.fileContent?e:e.value}),i},formDataUtils={FormData:builder,formParser:parser};const dbName_role="uni-id-roles",dbName_menu="opendb-admin-menus",dbName_permission="uni-id-permissions",DB_MAX_LIMIT$1=1e3;var dao={},util$e={};dao.init=function(e){util$e=e},dao.findRoleById=async(e="___")=>{let t,{vk:n,db:a,_:i}=util$e;return t=await n.baseDao.findByWhereJson({dbName:dbName_role,whereJson:{role_id:e}}),t},dao.roleBindPermission=async(e={})=>{let{vk:t,db:n,_:a}=util$e,i={code:0,msg:""},{role_id:r="___",permissionList:o=[],reset:s=!1}=e;if(!s){let e=await dao.findRoleById(r),{permission:t=[]}=e;o=t.concat(o),o=[...new Set(o)]}return i.num=await t.baseDao.update({dbName:dbName_role,whereJson:{role_id:r},dataJson:{permission:a.set(o)}}),i},dao.roleBindMenu=async(e={})=>{let{vk:t,db:n,_:a}=util$e,i={code:0,msg:""},{role_id:r="___",menuList:o=[],reset:s=!1,addPermission:u=!1}=e,l=[],c=await dao.findRoleById(r),{menu:d=[],permission:p=[]}=c;if(s?l=compareArray(o,d):(o=d.concat(o),o=[...new Set(o)]),i.num=await t.baseDao.update({dbName:dbName_role,whereJson:{role_id:r},dataJson:{menu:a.set(o)}}),u){let e=await dao.findMenuByIdsToPermission(o),n=[];if(s&&t.pubfn.isNotNull(l)){n=compareArray(e,await dao.findMenuByIdsToPermission(l))}p=p.concat(e),p=compareArray(n,p),p=[...new Set(p)],dao.roleBindPermission({role_id:r,permissionList:p,reset:!0})}return i},dao.findPermissionById=async(e="___")=>{let t,{vk:n,db:a,_:i}=util$e;return t=await n.baseDao.findByWhereJson({dbName:dbName_permission,whereJson:{permission_id:e}}),t},dao.findMenuByIdsToPermission=async e=>{let{vk:t,db:n,_:a}=util$e,i=await dao.findMenuByIds(e);if(t.pubfn.isNull(i))return[];let r=[];for(let e in i){let n=i[e].permission;t.pubfn.isNotNull(n)&&(r=r.concat(n))}return r=[...new Set(r)],r},dao.listPermissionToTree=async(e={})=>{let t,{vk:n,db:a,_:i}=util$e,{getCount:r=!1,pageSize:o=DB_MAX_LIMIT$1,pageIndex:s=1,whereJson:u={parent_id:i.in([null,""])},sortArr:l=[{name:"sort",type:"asc"}],treeProps:c={}}=e,{level:d=3,limit:p=DB_MAX_LIMIT$1,whereJson:f}=c;u&&!u.permission_id&&(u.permission_id=i.exists(!0)),t=await n.baseDao.selects({dbName:dbName_permission,pageIndex:s,pageSize:o,getCount:r,whereJson:u,sortArr:l,treeProps:{id:"permission_id",parent_id:"parent_id",children:"children",level:d,limit:p,whereJson:f,sortArr:l}});let g={id:"permission_id",parent_id:"parent_id",children:"children"},m=t.rows;m=n.pubfn.treeToArray(m,g),t.list=n.pubfn.copyObject(m);for(let e in m){let t=m[e],a="",i="";if(n.pubfn.isNotNull(t.level)){a=` - ${["未分类","子弹级","炸弹级","榴弹级","核弹级"][t.level]}（LV：${t.level}）`}if(n.pubfn.isNotNull(t.curd_category)){i=" - "+["未分类","增","删","改","查","特殊"][t.curd_category]}m[e].label=`${t.permission_name}（${t.permission_id}）${i}${a}`}return m=n.pubfn.arrayToTree(m,g),t.rows=m,t},dao.findMenuById=async(e="___")=>{let t,{vk:n,db:a,_:i}=util$e;return t=await n.baseDao.findByWhereJson({dbName:dbName_menu,whereJson:{menu_id:e}}),t},dao.findMenuByIds=async e=>{let t,{vk:n,db:a,_:i}=util$e;return n.pubfn.isNull(e)?[]:(t=(await n.baseDao.select({dbName:dbName_menu,pageIndex:1,pageSize:DB_MAX_LIMIT$1,whereJson:{menu_id:i.in(e)}})).rows,t)},dao.listMenuByRole=async(e={})=>{let{vk:t,db:n,_:a}=util$e,i={code:0,msg:"",menus:[],menuList:[]},{role:r,treeProps:o={}}=e,s=[],u={enable:!0},l={enable:!0};if(!(r.indexOf("admin")>-1)){if(t.pubfn.isNull(r))return i;let e=await t.baseDao.select({dbName:dbName_role,pageSize:DB_MAX_LIMIT$1,whereJson:{role_id:a.in(r),enable:!0},fieldJson:{menu:!0}});for(let n in e.rows){let{menu:a}=e.rows[n];t.pubfn.isNotNull(a)&&(s=s.concat(a))}if(0==s.length)return i;s=[...new Set(s)],u.menu_id=a.in(s),l.menu_id=a.in(s)}u.parent_id=a.in([null,""]);let c=[{name:"sort",type:"asc"}],{level:d=3,limit:p=DB_MAX_LIMIT$1}=o,f=await t.baseDao.selects({dbName:dbName_menu,pageIndex:1,pageSize:DB_MAX_LIMIT$1,whereJson:u,sortArr:c,treeProps:{id:"menu_id",parent_id:"parent_id",children:"children",level:d,limit:p,whereJson:l,sortArr:c}});return i.menus=f.rows,i.menuList=t.pubfn.treeToArray(f.rows,{id:"menu_id",parent_id:"parent_id",children:"children"}),i},dao.menuBindPermission=async(e={})=>{let{vk:t,db:n,_:a}=util$e,i={code:0,msg:""},{menu_id:r="___",permissionList:o=[],reset:s=!1}=e;if(!s){let e=await dao.findMenuById(r),{permission:t=[]}=e;o=t.concat(o),o=[...new Set(o)]}return i.num=await t.baseDao.update({dbName:dbName_menu,whereJson:{menu_id:r},dataJson:{permission:a.set(o)}}),i},dao.listMenuToTree=async(e={})=>{let t,{vk:n,db:a,_:i}=util$e,{getCount:r=!1,pageSize:o=DB_MAX_LIMIT$1,pageIndex:s=1,whereJson:u={parent_id:i.in([null,""]),menu_id:i.exists(!0)},sortArr:l=[{name:"sort",type:"asc"}],treeProps:c={}}=e,{level:d=3,limit:p=DB_MAX_LIMIT$1,whereJson:f}=c;u&&!u.menu_id&&(u.menu_id=i.exists(!0)),t=await n.baseDao.selects({dbName:dbName_menu,pageIndex:s,pageSize:o,getCount:r,whereJson:u,sortArr:l,treeProps:{id:"menu_id",parent_id:"parent_id",children:"children",level:d,limit:p,whereJson:f,sortArr:l}});let g={id:"menu_id",parent_id:"parent_id",children:"children"},m=t.rows;m=n.pubfn.treeToArray(m,g),t.list=n.pubfn.copyObject(m);for(let e in m){let t=m[e];m[e].label=`${t.name}（${t.menu_id}）`}return m=n.pubfn.arrayToTree(m,g),t.rows=m,t};var sysDao=dao;function compareArray(e,t){let n=new Set(e);return t.filter(e=>!n.has(e))}const dbName="vk-global-data";var dao$1={},util$f={};dao$1.init=function(e){util$f=e},dao$1.find=async e=>{let{vk:t,db:n,_:a}=util$f,i={};return i=await t.baseDao.findById({dbName:dbName,id:e}),i},dao$1.del=async e=>{let{vk:t,db:n,_:a}=util$f,i={};return i=await t.baseDao.deleteById({dbName:dbName,id:e}),i},dao$1.deleteByWhere=async e=>{let{vk:t,db:n,_:a}=util$f,i={};return i=await t.baseDao.del({dbName:dbName,whereJson:e}),i},dao$1.deleteExpired=async e=>{let{vk:t,db:n,_:a}=util$f,i={},r={};"string"==typeof e?r._id=e:"object"==typeof e&&(r=e);let o=(new Date).getTime();return i=await t.baseDao.del({dbName:dbName,whereJson:{...r,expired_at:a.gt(0).lte(o)}}),i},dao$1.update=async e=>{let{vk:t,db:n,_:a}=util$f,i={},{key:r,value:o,comment:s,expired_at:u}=e;return i=await t.baseDao.updateById({dbName:dbName,id:r,dataJson:{value:a.set(o),comment:s,expired_at:u}}),i},dao$1.add=async e=>{let{vk:t,db:n,_:a}=util$f,i={},{key:r,value:o,comment:s,expired_at:u}=e;return i=await t.baseDao.add({dbName:dbName,dataJson:{_id:r,key:r,value:o,comment:s,expired_at:u}}),i},dao$1.count=async e=>{let{vk:t,db:n,_:a}=util$f,i={};return i=await t.baseDao.count({dbName:dbName,whereJson:e}),i},dao$1.set=async e=>{let{vk:t,db:n,_:a}=util$f,i={code:0,msg:"ok"},r=new Date;e._add_time=r.getTime(),e._add_time_str=t.pubfn.timeFormat(r,"yyyy-MM-dd hh:mm:ss");let o=await n.collection(dbName).doc(e.key).set(e);return o.updated?(i.mode="update",i.updated=o.updated):(i.id=o.upsertedId||e.key,i.mode="add"),i.num=1,i},dao$1.inc=async e=>{let{vk:t,db:n,_:a}=util$f,{key:i,value:r,expired_at:o}=e,s={},u=await t.baseDao.updateById({dbName:dbName,id:i,dataJson:{value:a.inc(r),expired_at:o}});if(0==u){0===await dao$1.count({_id:i})&&(s.id=await dao$1.add(e),s.num=1,s.mode="add")}else s.num=u,s.mode="update";return s},dao$1.list=async e=>{let{vk:t,db:n,_:a}=util$f,i={},{pageIndex:r,pageSize:o,whereJson:s,sortArr:u}=e;return i=await t.baseDao.select({dbName:dbName,pageIndex:r,pageSize:o,whereJson:s,sortArr:u}),i},dao$1.updateById=async(e,t)=>{let{vk:n,db:a,_:i}=util$f,r={};return r=await n.baseDao.updateById({dbName:dbName,id:e,dataJson:t}),r},dao$1.delByValue=async(e,t)=>{let{vk:n,db:a,_:i}=util$f,r={};return r=await n.baseDao.del({dbName:dbName,whereJson:{_id:e,value:t}}),r};var globalDataDao$1=dao$1,util$g={},smsUtil={init:function(e){util$g=e}},aliyun={specialUrlEncode:function(e){return(e=encodeURIComponent(e)).replace(/\+/g,"%20").replace(/\*/g,"%2A").replace(/%7E/g,"~")},sign:function(e,t){let{crypto:n}=util$g;return n.createHmac("sha1",e).update(t).digest("base64")}};smsUtil.sendSms=async function(e){let{vk:t,config:n}=util$g,{provider:a,appid:i,smsKey:r,smsSecret:o,signName:s,phone:u,templateId:l,data:c}=e,d={};if("aliyun"===a){let a=t.pubfn.getData(n,"vk.service.sms.aliyun");t.pubfn.isNotNull(a)&&(r||(e.smsKey=a.accessKeyId),o||(e.smsSecret=a.accessKeySecret),s||(e.signName=a.signName)),d=await smsUtil.sendSmsByAliyun(e)}else{if("unicloud"!==a)return{code:-1,msg:`暂不支持${a}供应商`};{let a=t.pubfn.getUniIdConfig(n,"service.sms");t.pubfn.isNotNull(a)&&(r||(e.smsKey=a.smsKey),o||(e.smsSecret=a.smsSecret),s||(e.signName=a.signName)),d=await smsUtil.sendSmsByUnicloud(e)}}return d.requestParam={provider:a,phone:u},d},smsUtil.sendSmsByAliyun=async function(e){let{vk:t,config:n}=util$g,{provider:a,appid:i,smsKey:r,smsSecret:o,signName:s,phone:u,templateId:l,data:c}=e,d={code:0,msg:""};try{if(t.pubfn.isNullOne(r,o))return{code:-1,msg:"阿里云短信配置错误，请检查vk-unicloud配置下的vk.service.sms.aliyun配置的accessKeyId和accessKeySecret是否正确"};let e="https://dysmsapi.aliyuncs.com",n=t.pubfn.timeFormat(new Date,"yyyy-MM-ddThh:mm:ssZ",0),a=(new Date).getTime().toString().substring(7)+t.pubfn.random(30);"object"==typeof c&&(c=JSON.stringify(c));let i={SignatureMethod:"HMAC-SHA1",SignatureNonce:a,AccessKeyId:r,SignatureVersion:"1.0",Timestamp:n,Format:"json",Action:"SendSms",Version:"2017-05-25",PhoneNumbers:u,SignName:s,TemplateParam:c,TemplateCode:l};delete i.Signature;let p=[];for(let e in i)p.push(e);p.sort();let f=!1,g="";for(let e in p){let t=p[e];g+="&"+aliyun.specialUrlEncode(t)+"="+aliyun.specialUrlEncode(i[t])}g=g.substring(1);let m="GET&"+aliyun.specialUrlEncode("/")+"&"+aliyun.specialUrlEncode(g),b=aliyun.sign(o+"&",m),h=aliyun.specialUrlEncode(b),y="Signature="+h+"&"+g;f&&(console.log("\r\n随机数\r\n"),console.log(i.SignatureNonce),console.log("\r\n=========\r\n"),console.log(i.Timestamp),console.log("\r\n====sortedQueryString====\r\n"),console.log(g),console.log("\r\n=====stringToSign====\r\n"),console.log(m),console.log("\r\n=====sign====\r\n"),console.log(b),console.log("\r\n=====signature====\r\n"),console.log(h),console.log("\r\n=========\r\n"),console.log(e+"/?"+y));t.pubfn.urlStringToJson(y);let w=await t.request({url:`${e}?${y}`,method:"GET"});return d="OK"===w.Code?{code:0,msg:"ok",requestRes:w}:{code:-1,msg:w.Message,requestRes:w},d}catch(e){return{code:-1,msg:"短信发送失败",err:{message:e.message,stack:e.stack}}}},smsUtil.sendSmsByUnicloud=async function(e){let{provider:t,appid:n,smsKey:a,smsSecret:i,signName:r,phone:o,templateId:s,data:u}=e,l={code:0,msg:""};try{let e=await uniCloud.sendSms({smsKey:a,smsSecret:i,phone:o,templateId:s,data:u});l=0==e.code||0==e.errCode?{code:0,msg:"ok",requestRes:e}:{code:-1,msg:e.errMessage||e.errMsg,requestRes:e}}catch(e){return console.log(e),{code:-1,msg:"短信发送失败",err:{message:e.message,stack:e.stack}}}return l},smsUtil.sendSmsVerifyCode=async function(e){let t,{vk:n,config:a,uniID:i}=util$g,{provider:r,phone:o,code:s,type:u,expiresIn:l=180}=e,c={code:0,msg:""};if("unicloud"===r){t=n.pubfn.getUniIdConfig(a,"service.sms.templateId");let e=n.pubfn.getUniIdConfig(a,"service.sms.codeExpiresIn");e&&(l=e);let i=n.pubfn.getUniIdConfig(a,"service.sms.name"),u=Math.ceil(l/60).toString();c=await n.system.smsUtil.sendSms({provider:r,phone:o,templateId:t,data:{code:s,name:i,action:"身份验证",expMinute:u}})}else t=n.pubfn.getData(a,`vk.service.sms.${r}.templateCode.verifyCode`),c=await n.system.smsUtil.sendSms({provider:r,phone:o,templateId:t,data:{code:s}});return 0===c.code&&await i.setVerifyCode({mobile:o,code:s,expiresIn:l,type:u}),c};var smsUtil_1=smsUtil,system={};system.sysDao=sysDao,system.globalDataDao=globalDataDao$1,system.smsUtil=smsUtil_1,system.init=function(e){let t=["sysDao","globalDataDao","smsUtil"];for(let n in t){let a=t[n];"function"==typeof system[a].init&&system[a].init(e)}};var system_1=system;class ReentrantLock{constructor(e={}){let{id:t,timeout:n=5,debug:a=!1}=e,i=uniCloud.vk;if(i.pubfn.isNull(t))throw new Error("msg:锁的id不能为空");this.key=t,this.timeout=n,this.debug=a,this.password=i.pubfn.random(16),this.log("锁生成成功，解锁密码："+this.password)}log(...e){this.debug&&console.log(this.key+":",...e)}async lock(){let e=uniCloud.vk,t=this.key,n=e.getCacheManage();return new Promise(async(e,a)=>{try{const a=()=>{e(this)};0===(await n.setnx(t,this.password,this.timeout)).code?(this.log("锁未被占用，立即获取锁，并设置锁的密码"+this.password),a()):(this.log("锁已被占用"),e())}catch(e){a(e)}})}async unlock(){let e=uniCloud.vk,t=this.key,n=e.getCacheManage();return new Promise(async(e,a)=>{try{await n.delByValue(t,this.password)>0?(this.log("锁解锁成功"),e({code:0,msg:"解锁成功"})):(this.log("锁解锁失败",this.password),e({code:-1,msg:"解锁失败"}))}catch(e){a(e)}})}async withLock(e){uniCloud.vk.pubfn.isNull(key)&&(this.key=crypto$1.createHash("md5").update(e.toString()).digest("hex")),await this.lock();try{return await e()}finally{await this.unlock()}}}var reentrantLockManage=function(...e){return new ReentrantLock(...e)};class CacheManage{constructor(e={}){let{mode:t="db"}=e;this.cache="redis"===t?new RedisCache(e):new GlobalDataCache(e),this.options={mode:t}}async get(e){return await this.cache.get(e)}async set(e,t,n=0){return await this.cache.set(e,t,n)}async setnx(e,t,n){return await this.cache.setnx(e,t,n)}async del(e){return await this.cache.del(e)}async delByValue(e,t){return await this.cache.delByValue(e,t)}async clear(e){return await this.cache.clear(e)}async count(e){return await this.cache.count(e)}async exists(e){return await this.cache.exists(e)}async expire(e,t){return await this.cache.expire(e,t)}async ttl(e){return await this.cache.ttl(e)}async pttl(e){return await this.cache.pttl(e)}}class GlobalDataCache{constructor(e={}){this.options=e}async get(e){return await uniCloud.vk.globalDataCache.get(e)}async set(e,t,n=0){let a={code:0,msg:"ok"},i=await uniCloud.vk.globalDataCache.set(e,t,n);return a.code=i.code,a.msg=i.msg,a.mode=i.mode,a.key=e,a}async setnx(e,t,n){let a={code:0,msg:"ok"};return 0!==(await uniCloud.vk.globalDataCache.uniqueAdd(e,t,n)).code&&(a.code=-1,a.msg="already exists"),a.key=e,a}async del(e){return await uniCloud.vk.globalDataCache.del(e)}async delByValue(e,t){return await uniCloud.vk.globalDataCache.delByValue(e,t)}async clear(e){return await uniCloud.vk.globalDataCache.clear(e)}async count(e){return await uniCloud.vk.globalDataCache.count({key:new RegExp("^"+e)})}async exists(e){return await uniCloud.vk.globalDataCache.count({key:e})}async expire(e,t){let n=0;return t&&(n=Date.now()+1e3*t),await uniCloud.vk.globalDataCache.updateById(e,{expired_at:n})}async ttl(e){let t=(await uniCloud.vk.globalDataCache.find(e)).expired_at,n=uniCloud.vk.pubfn.toDecimal((t-Date.now())/1e3,0);return n<0?0:n}async pttl(e){let t=(await uniCloud.vk.globalDataCache.find(e)).expired_at,n=uniCloud.vk.pubfn.toDecimal(t-Date.now(),0);return n<0?0:n}}class RedisCache{constructor(e={}){this.options=e}getRedis(){return this.redis||(this.redis=uniCloud.vk.redis()),this.redis}async get(e){let t=this.getRedis(),n=await t.get(e);try{n=JSON.parse(n)}catch(e){}return n=uniCloud.vk.pubfn.string2Number(n),n}async set(e,t,n=0){let a,i=this.getRedis(),r={code:0,msg:"ok"},o=await i.exists(e);return r.mode=o?"update":"add","object"==typeof t&&(t=JSON.stringify(t)),a=n>0?await i.set(e,t,"EX",n):await i.set(e,t),r.key=e,a||(r.code=-1,r.msg="fail"),r}async setnx(e,t,n=0){let a,i=this.getRedis(),r={code:0,msg:"ok"};return"object"==typeof t&&(t=JSON.stringify(t)),a=n>0?await i.set(e,t,"EX",n,"NX"):await i.set(e,t,"NX"),r.key=e,a||(r.code=-1,r.msg="already exists"),r}async del(...e){let t=this.getRedis();return await t.del(...e)}async delByValue(e,t){let n=await this.get(e);return String(n)===String(t)?await this.del(e):0}async clear(e){let t=this.getRedis();if(e){let n="0",a=[];do{const[i,r]=await t.scan(n,"MATCH",e+"*");n=i,a=a.concat(r)}while("0"!==n);return a.length>0?await t.del(a):0}}async count(e){let t=this.getRedis(),n="0",a=0;do{const[i,r]=await t.scan(n,"MATCH",e+"*");n=i,a+=r.length}while("0"!==n);return a}async exists(e){let t=this.getRedis();return await t.exists(e)}async expire(e,t){let n=this.getRedis();return t?await n.expire(e,t):await n.persist(e)}async ttl(e){let t=this.getRedis();return await t.ttl(e)}async pttl(e){let t=this.getRedis();return await t.pttl(e)}}var cacheManage=function(e={}){let{mode:t}=e;return t||(t=uniCloud.vk.getConfig("vk.cacheManage.mode","db")),new CacheManage({mode:t})},vkunicloud={};class VK{constructor(e){this.router=router,this.md5=md5,this.baseDao=vkBaseDao,this.request=vk_request,this.callFunction=vk_callFunction,this.pubfn=_function,this.temporaryCache=temporaryCache,this.globalDataCache=globalDataCache_1,this.crypto=crypto,this.openapi=openapi_1,this.formDataUtil=formDataUtils,this.system=system_1,this.getReentrantLockManage=reentrantLockManage,this.getCacheManage=cacheManage,this.baseDir=null,e&&this.init(e)}require(e){return vkunicloud.requireFn(this.baseDir+"/"+e)}requireFn(e){try{return vkunicloud.requireFn(e)}catch(e){let{message:t=""}=e;return void(-1==t.indexOf("Cannot find module")&&-1==t.indexOf("no such file or directory")&&console.error(e))}}use(e,t){for(let n in e)e[n]&&"function"==typeof e[n].init&&e[n].init(t),this[n]=e[n]}getGlobalObject(){return"object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof commonjsGlobal?commonjsGlobal:void 0}init(e={}){let t=this;if(e.requireFn&&(vkunicloud.requireFn=e.requireFn),e.baseDir&&(t.baseDir=e.baseDir),e.configCenter||(e.configCenter=t.requireFn("uni-config-center")),e.uniID||(e.uniID=t.requireFn("uni-id")),e.uniPay||(e.uniPay=t.requireFn("uni-pay")),e.middlewareService||(e.middlewareService=t.requireFn("./middleware/index")),e.daoCenter||(e.daoCenter=t.requireFn("./dao/index")),e.crypto||(e.crypto=t.requireFn("crypto")),e.urlrewrite||(e.urlrewrite=t.requireFn("./util/urlrewrite")),e.config||(e.config=e.configCenter({pluginId:"vk-unicloud"}).requireFile("index.js")),!e.config)throw new Error("配置文件：uniCloud/cloudfunctions/common/uni-config-center/vk-unicloud/index.js \n编译错误，请检查！");if(!e.db)try{e.db=uniCloud.database()}catch(e){}if(t.vkPay=t.requireFn("vk-uni-pay"),e.pubFun||(e.pubFun=t.requireFn("./util/pubFunction")),e.pubFun&&(t.myfn=e.pubFun),e.redis||(e.redis=t.requireFn("vk-redis")),e.redis)t.redisUtil=e.redis,t.redis=e.redis.redis,t.newRedis=e.redis.newRedis;else try{t.redis=uniCloud.redis}catch(e){}e.uniMap||(e.uniMap=t.requireFn("uni-map-common")),e.uniMap&&(t.uniMap=e.uniMap),e.db&&(vkunicloud.db=e.db,vkunicloud._=e.db.command),vkunicloud.pubfn=t.pubfn,e.configCenter&&(vkunicloud.configCenter=e.configCenter),e.config&&(vkunicloud.config=e.config),e.uniID&&(vkunicloud.uniID=e.uniID),e.uniPay&&(vkunicloud.uniPay=e.uniPay),e.middlewareService&&(vkunicloud.middlewareService=e.middlewareService),e.pubFun&&(vkunicloud.pubFun=e.pubFun),e.customUtil&&(vkunicloud.customUtil=e.customUtil),e.crypto&&(vkunicloud.crypto=e.crypto),e.urlrewrite&&(vkunicloud.urlrewrite=e.urlrewrite);const n={vk:t,...vkunicloud};t.use({daoCenter:e.daoCenter,baseDao:t.baseDao,openapi:t.openapi,globalDataCache:t.globalDataCache,system:t.system,pubFun:e.pubFun},n);try{let n=t.getGlobalObject();"object"==typeof n&&e.middlewareService&&(n.vk=t)}catch(e){}try{Object.getPrototypeOf(uniCloud).vk=t}catch(e){}}getUnicloud(){return vkunicloud}getConfig(e,t){if(_function.isNull(e))return vkunicloud.config;let n=_function.getData(vkunicloud.config,e);return _function.isNull(n)&&void 0!==t&&(n=t),n}createInstance(e){return new VK(e)}}var src=new VK;module.exports=src;
